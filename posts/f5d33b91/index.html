<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="TWTqGRcdm7qMQZ1XqfQLJEwhOaDcUy81paYiE7e3tyw">
  <meta name="msvalidate.01" content="05EA84E81FBC0002CD044701E7E4E569">
  <meta name="baidu-site-verification" content="codeva-uXj8zM8tQ9">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.wylu.me","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":null,"activeClass":"changyan"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="通过本文的指导，读者可以了解如何通过二进制的方式部署 Kubernetes 1.27.3 版本集群。二进制部署可以加深对 Kubernetes 各组件的理解，可以灵活地将各个组件部署到不同的机器，以满足自身的要求。但是需要注意的是，二进制部署需要手动配置各个组件，需要一定的技术水平和经验。">
<meta property="og:type" content="article">
<meta property="og:title" content="二进制部署 k8s 集群 1.27.3 版本">
<meta property="og:url" content="https://www.wylu.me/posts/f5d33b91/index.html">
<meta property="og:site_name" content="wylu">
<meta property="og:description" content="通过本文的指导，读者可以了解如何通过二进制的方式部署 Kubernetes 1.27.3 版本集群。二进制部署可以加深对 Kubernetes 各组件的理解，可以灵活地将各个组件部署到不同的机器，以满足自身的要求。但是需要注意的是，二进制部署需要手动配置各个组件，需要一定的技术水平和经验。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-07T16:11:56.000Z">
<meta property="article:modified_time" content="2023-08-07T16:24:11.062Z">
<meta property="article:author" content="lu wenye">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.wylu.me/posts/f5d33b91/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.wylu.me/posts/f5d33b91/","path":"posts/f5d33b91/","title":"二进制部署 k8s 集群 1.27.3 版本"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>二进制部署 k8s 集群 1.27.3 版本 | wylu</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155154294-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-155154294-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "enj9prl9r6");
</script>



<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5699403938610067" crossorigin="anonymous"></script>

<!-- https://github.com/metowolf/MetingJS -->
<!-- require APlayer -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/meting/2.0.1/Meting.min.js"></script>
<meting-js id="10024930877" server="netease" type="playlist" fixed="true" mini="true" autoplay="false" theme="#607d8b" loop="all" order="list" preload="auto" volume="1.0" mutex="true" lrc-type="0" list-folded="true" list-max-height="340px" storage-name="metingjs">
</meting-js>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="wylu" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">wylu</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Keep It Simple, Stupid</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">79</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">46</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">94</span></a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-commenting fa-fw"></i>留言</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-k8s-%E9%9B%86%E7%BE%A4-1.27.3-%E7%89%88%E6%9C%AC"><span class="nav-text">二进制部署 k8s 集群 1.27.3 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">1. 环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%A6%E5%86%99%E7%BA%A6%E5%AE%9A"><span class="nav-text">1.1 书写约定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%BA%E5%99%A8%E8%A7%84%E5%88%92"><span class="nav-text">1.2 机器规划</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F"><span class="nav-text">1.2.1 操作系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9"><span class="nav-text">1.2.2 集群节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%8A%82%E7%82%B9%E5%8F%AF%E9%80%89"><span class="nav-text">1.2.3 测试节点（可选）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-text">1.3 环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E7%BD%AE"><span class="nav-text">1.3.1 基础设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#k8s-%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="nav-text">1.3.2 k8s 环境设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="nav-text">1.3.3 网络环境设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E7%B3%BB%E7%BB%9F"><span class="nav-text">1.3.4 重启系统</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85"><span class="nav-text">1.4 下载二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E7%89%88%E6%9C%AC"><span class="nav-text">1.5 查看镜像版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="nav-text">2. 容器运行时</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-containerd"><span class="nav-text">2.1 安装 containerd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-containerd-cli-%E5%B7%A5%E5%85%B7"><span class="nav-text">2.2 安装 containerd cli 工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ctr"><span class="nav-text">2.2.1 ctr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#crictl"><span class="nav-text">2.2.2 crictl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nerdctl%E6%8E%A8%E8%8D%90"><span class="nav-text">2.2.3 nerdctl（推荐）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%85%AC%E5%85%B1%E4%BB%93%E5%BA%93%E9%95%9C%E5%83%8F%E6%BA%90%E5%8F%AF%E9%80%89"><span class="nav-text">2.3 设置公共仓库镜像源（可选）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker.io"><span class="nav-text">2.3.1 docker.io</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#registry.k8s.io"><span class="nav-text">2.3.2 registry.k8s.io</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%80%E9%94%99%E8%AF%AF"><span class="nav-text">2.3.2.1 配置一（错误）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BA%8C%E9%94%99%E8%AF%AF"><span class="nav-text">2.3.2.2 配置二（错误）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%89%E6%AD%A3%E7%A1%AE"><span class="nav-text">2.3.2.3 配置三（正确）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#quay.io"><span class="nav-text">2.3.3 quay.io</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E5%8F%AF%E9%80%89"><span class="nav-text">2.4 设置私有仓库（可选）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93"><span class="nav-text">2.4.1 部署私有仓库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-docker"><span class="nav-text">2.4.1.1 安装 docker</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-registry"><span class="nav-text">2.4.1.2 部署 registry</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#registry.local"><span class="nav-text">2.4.2 registry.local</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93"><span class="nav-text">2.4.3 测试私有仓库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-ca-%E8%AF%81%E4%B9%A6"><span class="nav-text">3. 创建 ca 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-cfssl"><span class="nav-text">3.1 安装 cfssl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-ca-%E8%AF%81%E4%B9%A6-1"><span class="nav-text">3.2 创建 ca 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AD%BE%E5%8F%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">3.3 创建签发配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-etcd"><span class="nav-text">4. 部署 etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="nav-text">4.1 颁发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-etcd-1"><span class="nav-text">4.2 部署 etcd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-apiserver"><span class="nav-text">5. 部署 kube-apiserver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6-1"><span class="nav-text">5.1 颁发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-apiserver-1"><span class="nav-text">5.2 部署 kube-apiserver</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-kubectl"><span class="nav-text">6. 配置 kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6-2"><span class="nav-text">6.1 颁发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">6.2 生成配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%9B%86%E7%BE%A4%E4%BF%A1%E6%81%AF"><span class="nav-text">6.3 获取集群信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE-kubectl-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="nav-text">6.4 设置 kubectl 自动补全</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-controller-manager"><span class="nav-text">7. 部署 kube-controller-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6-3"><span class="nav-text">7.1 颁发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-controller-manager-1"><span class="nav-text">7.2 部署 kube-controller-manager</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-scheduler"><span class="nav-text">8. 部署 kube-scheduler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6-4"><span class="nav-text">8.1 颁发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-scheduler-1"><span class="nav-text">8.2 部署 kube-scheduler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kubelet"><span class="nav-text">9. 部署 kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83-kubelet-%E5%85%81%E8%AE%B8%E8%AF%B7%E6%B1%82%E8%AF%81%E4%B9%A6"><span class="nav-text">9.1 授权 kubelet 允许请求证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kubelet-1"><span class="nav-text">9.2 部署 kubelet</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-proxy"><span class="nav-text">10. 部署 kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6-5"><span class="nav-text">10.1 颁发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-kube-proxy-1"><span class="nav-text">10.2 部署 kube-proxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4%E7%BD%91%E7%BB%9C"><span class="nav-text">11. 部署集群网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-calico"><span class="nav-text">11.1 部署 calico</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83-kube-apiserver-%E8%AE%BF%E9%97%AE-kubelet"><span class="nav-text">11.2 授权 kube-apiserver 访问 kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-coredns"><span class="nav-text">11.3 部署 coredns</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-worker-%E8%8A%82%E7%82%B9"><span class="nav-text">12. 添加 worker 节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A6%81%E6%AD%A2-master-%E8%8A%82%E7%82%B9%E8%BF%90%E8%A1%8C-pod"><span class="nav-text">13. 禁止 master 节点运行 pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2"><span class="nav-text">14. 测试应用服务部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-dashboard"><span class="nav-text">15. 部署 Dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-text">16. 附录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#coredns.yaml.sed"><span class="nav-text">16.1 coredns.yaml.sed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#helm-%E5%AE%89%E8%A3%85-coredns"><span class="nav-text">16.2 helm 安装 coredns</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references"><span class="nav-text">References</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lu wenye" src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">lu wenye</p>
  <div class="site-description" itemprop="description">Hard work, Dedication and Discipline</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">94</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">79</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wylu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wylu" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:15wylu@gmail.com" title="E-Mail → mailto:15wylu@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_32767041" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_32767041" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-book fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
        <div class="pjax">
        <div class="sidebar-inner sidebar-post-related">
          <div class="animated">
              <div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i>
    相关文章
  </div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/posts/b4d8958f/" rel="bookmark">
        <time class="popular-posts-time">2023-04-07</time>
        <br>
      二进制部署 k8s 集群 1.23.6 版本
      </a>
    </li>
    <li class="popular-posts-item">
      <a class="popular-posts-link" href="/posts/ab2a96fe/" rel="bookmark">
        <time class="popular-posts-time">2023-07-23</time>
        <br>
      Docker 磁盘清理
      </a>
    </li>
  </ul>

          </div>
        </div>
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.wylu.me/posts/f5d33b91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="lu wenye">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wylu">
      <meta itemprop="description" content="Hard work, Dedication and Discipline">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="二进制部署 k8s 集群 1.27.3 版本 | wylu">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          二进制部署 k8s 集群 1.27.3 版本
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-08-08 00:11:56 / 修改时间：00:24:11" itemprop="dateCreated datePublished" datetime="2023-08-08T00:11:56+08:00">2023-08-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cloud/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>21 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>通过本文的指导，读者可以了解如何通过二进制的方式部署 Kubernetes 1.27.3 版本集群。二进制部署可以加深对 Kubernetes 各组件的理解，可以灵活地将各个组件部署到不同的机器，以满足自身的要求。但是需要注意的是，二进制部署需要手动配置各个组件，需要一定的技术水平和经验。</p>
<span id="more"></span>
<h1 id="二进制部署-k8s-集群-1.27.3-版本">二进制部署 k8s 集群 1.27.3 版本</h1>
<h2 id="环境准备">1. 环境准备</h2>
<p>虽然 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/">kubeadm</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kops/">kops</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/">kubespray</a> 以及 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.rancher.cn/rke/">rke</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubesphere.io/zh/docs/">kubesphere</a> 等工具可以快速部署 k8s 集群，但是依然会有很多人热衷与使用二进制部署 k8s 集群。</p>
<p>二进制部署可以加深对 k8s 各组件的理解，可以灵活地将各个组件部署到不同的机器，以满足自身的要求。还可以生成一个超长时间自签证书，比如 99 年，免去忘记更新证书过期带来的生产事故。</p>
<h3 id="书写约定">1.1 书写约定</h3>
<ul>
<li>命令行输入，均以 <code>➜</code> 符号表示</li>
<li>注释使用 <code>#</code> 或 <code>//</code> 表示</li>
<li>执行命令输出结果，以空行分隔</li>
<li>如无特殊说明，命令需要在全部集群节点执行</li>
</ul>
<h3 id="机器规划">1.2 机器规划</h3>
<h4 id="操作系统">1.2.1 操作系统</h4>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.6-x86_64-minimal.iso">Rocky-8.6-x86_64-minimal.iso</a></p>
<h4 id="集群节点">1.2.2 集群节点</h4>
<table>
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>角色</th>
<th>主机名</th>
<th>IP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>master</td>
<td>master1</td>
<td>10.128.170.21</td>
<td>etcd, kube-apiserver, kube-controller-manager, kubelet, kube-proxy, kube-scheduler</td>
</tr>
<tr class="even">
<td>worker</td>
<td>worker1</td>
<td>10.128.170.131</td>
<td>kubelet, kube-proxy</td>
</tr>
<tr class="odd">
<td>worker</td>
<td>worker2</td>
<td>10.128.170.132</td>
<td>kubelet, kube-proxy</td>
</tr>
<tr class="even">
<td>worker</td>
<td>worker3</td>
<td>10.128.170.133</td>
<td>kubelet, kube-proxy</td>
</tr>
</tbody>
</table>
<h4 id="测试节点可选">1.2.3 测试节点（可选）</h4>
<table>
<thead>
<tr class="header">
<th>角色</th>
<th>主机名</th>
<th>IP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>registry</td>
<td>registry</td>
<td>10.128.170.235</td>
<td>docker</td>
</tr>
</tbody>
</table>
<h3 id="环境配置">1.3 环境配置</h3>
<h4 id="基础设置">1.3.1 基础设置</h4>
<ul>
<li><p>设置主机名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 master1 节点执行</span></span><br><span class="line">➜ hostnamectl set-hostname master1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 worker1 节点执行</span></span><br><span class="line">➜ hostnamectl set-hostname worker1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 worker2 节点执行</span></span><br><span class="line">➜ hostnamectl set-hostname worker2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 worker3 节点执行</span></span><br><span class="line">➜ hostnamectl set-hostname worker3</span><br></pre></td></tr></table></figure></li>
<li><p>主机名解析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">10.128.170.21 master1 master1.local</span><br><span class="line">10.128.170.131 worker1 worker1.local</span><br><span class="line">10.128.170.132 worker2 worker2.local</span><br><span class="line">10.128.170.133 worker3 worker3.local</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li>
<li><p>免密登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 master1 节点上执行（允许 master1 免密登录其他节点）</span></span><br><span class="line">➜ ssh-keygen -t rsa</span><br><span class="line">➜ ssh-copy-id worker1</span><br><span class="line">➜ ssh-copy-id worker2</span><br><span class="line">➜ ssh-copy-id worker3</span><br></pre></td></tr></table></figure></li>
<li><p>设置 yum 源</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.aliyun.com/mirror/rockylinux" class="uri">https://developer.aliyun.com/mirror/rockylinux</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行以下命令替换默认源</span></span><br><span class="line">➜ sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \</span><br><span class="line">    -e &#x27;s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g&#x27; \</span><br><span class="line">    -i.bak \</span><br><span class="line">    /etc/yum.repos.d/Rocky-*.repo</span><br><span class="line"></span><br><span class="line">➜ dnf makecache</span><br></pre></td></tr></table></figure></li>
<li><p>设置 epel 源</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.aliyun.com/mirror/epel" class="uri">https://developer.aliyun.com/mirror/epel</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm</span><br><span class="line">➜ sed -i &#x27;s|^#baseurl=https://download.example/pub|baseurl=https://mirrors.aliyun.com|&#x27; /etc/yum.repos.d/epel*</span><br><span class="line">➜ sed -i &#x27;s|^metalink|#metalink|&#x27; /etc/yum.repos.d/epel*</span><br></pre></td></tr></table></figure></li>
<li><p>安装必要工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ yum install -y vim wget htop</span><br></pre></td></tr></table></figure></li>
<li><p>创建下载文件存放目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ mkdir -p ~/Downloads</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="k8s-环境设置">1.3.2 k8s 环境设置</h4>
<ul>
<li><p>关闭防火墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl stop firewalld</span><br><span class="line">➜ systemctl disable firewalld</span><br></pre></td></tr></table></figure></li>
<li><p>关闭 selinux</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时</span></span><br><span class="line">➜ setenforce 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久</span></span><br><span class="line">➜ sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure></li>
<li><p>关闭 swap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时</span></span><br><span class="line">➜ swapoff -a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久</span></span><br><span class="line">➜ sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br></pre></td></tr></table></figure>
<p>使用 <code>-r</code> 选项可以使用扩展正则表达式，这提供了一种更强大和灵活的方式来匹配文本中的模式。</p>
<p>使用正则表达式 <code>.*swap.*</code> 匹配包含 swap 字符串的行，并在行首添加 # 符号，&amp; 表示匹配到的整个字符串。</p></li>
<li><p>设置文件描述符限制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时</span></span><br><span class="line">➜ ulimit -SHn 65535</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久</span></span><br><span class="line">➜ echo &quot;*      -      nofile   65535&quot; &gt;&gt;/etc/security/limits.conf</span><br></pre></td></tr></table></figure>
<p>用于设置当前用户的最大文件描述符数限制。具体来说，它的作用是将当前用户的软限制和硬限制都设置为 65535。</p></li>
<li><p>时间同步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置时区</span></span><br><span class="line">➜ timedatectl set-timezone Asia/Shanghai</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装时间同步服务</span></span><br><span class="line">➜ yum install -y chrony</span><br><span class="line">➜ systemctl enable --now chronyd</span><br></pre></td></tr></table></figure></li>
<li><p>创建 kubernetes 证书存放目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ mkdir -p /etc/kubernetes/pki</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="网络环境设置">1.3.3 网络环境设置</h4>
<ul>
<li><p>转发 IPv4 并让 iptables 看到桥接流量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载 br_netfilter 和 overlay 模块</span></span><br><span class="line">➜ cat &gt; /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line">➜ modprobe overlay</span><br><span class="line">➜ modprobe br_netfilter</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置所需的 sysctl 参数，参数在重新启动后保持不变</span></span><br><span class="line">➜ cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">应用 sysctl 参数而不重新启动</span></span><br><span class="line">➜ sysctl --system</span><br></pre></td></tr></table></figure>
<p>通过以下命令确认 br_netfilter 和 overlay 模块被加载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ lsmod | grep overlay</span><br><span class="line">➜ lsmod | grep br_netfilter</span><br></pre></td></tr></table></figure>
<p>通过以下命令确认 net.bridge.bridge-nf-call-iptables、net.bridge.bridge-nf-call-ip6tables 和 net.ipv4.ip_forward 系统变量在你的 sysctl 配置中被设置为 1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward</span><br></pre></td></tr></table></figure></li>
<li><p>加载 ipvs 模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜ yum install -y ipset ipvsadm</span><br><span class="line">➜ cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; &quot;EOF&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">EOF</span><br><span class="line">➜ chmod +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">➜ /bin/bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span></span><br><span class="line">➜ lsmod | grep -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>
<ul>
<li>modprobe -- ip_vs: 加载 ip_vs 内核模块，该模块提供了 Linux 内核中的 IP 负载均衡功能。</li>
<li>modprobe -- ip_vs_rr: 加载 ip_vs_rr 内核模块，该模块提供了基于轮询算法的 IP 负载均衡策略。</li>
<li>modprobe -- ip_vs_wrr: 加载 ip_vs_wrr 内核模块，该模块提供了基于加权轮询算法的 IP 负载均衡策略。</li>
<li>modprobe -- ip_vs_sh: 加载 ip_vs_sh 内核模块，该模块提供了基于哈希算法的 IP 负载均衡策略。</li>
<li>modprobe -- nf_conntrack/nf_conntrack_ipv4: 加载 nf_conntrack/nf_conntrack_ipv4 内核模块，该模块提供了 Linux 内核中的网络连接跟踪功能，用于跟踪网络连接的状态。</li>
</ul>
<p>这些命令通常用于配置 Linux 系统中的负载均衡和网络连接跟踪功能。在加载这些内核模块之后，就可以使用相应的工具和命令来配置和管理负载均衡和网络连接跟踪。例如，可以使用 ipvsadm 命令来配置 IP 负载均衡，使用 conntrack 命令来查看和管理网络连接跟踪表。</p>
<p>如果提示如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;modprobe: FATAL: Module nf_conntrack_ipv4 not found in directory /lib/modules/4.18.0-372.9.1.el8.x86_64&quot;</span><br></pre></td></tr></table></figure>
<p>则需要将 <code>nf_conntrack_ipv4</code> 修改为 <code>nf_conntrack</code>，然后重新执行命令，因为在高版本内核中已经把 nf_conntrack_ipv4 替换为 nf_conntrack。</p>
<p>nf_conntrack_ipv4 和 nf_conntrack 都是 Linux 内核中的网络连接跟踪模块，用于跟踪网络连接的状态。它们的区别在于：</p>
<ul>
<li>nf_conntrack_ipv4 模块只能跟踪 IPv4 协议的网络连接，而 nf_conntrack 模块可以跟踪 IPv4 和 IPv6 协议的网络连接。</li>
<li>nf_conntrack_ipv4 模块是 nf_conntrack 模块的一个子模块，它提供了 IPv4 协议的网络连接跟踪功能。因此，如果要使用 nf_conntrack_ipv4 模块，必须先加载 nf_conntrack 模块。</li>
</ul>
<p>这两个模块通常用于 Linux 系统中的网络安全和网络性能优化。它们可以被用于防火墙、负载均衡、网络流量分析等场景中，以便对网络连接进行跟踪、监控和控制。例如，可以使用 iptables 命令和 nf_conntrack 模块来实现基于连接状态的防火墙规则，或者使用 ipvsadm 命令和 nf_conntrack 模块来实现 IP 负载均衡。</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/xiangsikai/p/9525287.html">Linux 跟踪连接netfilter 调优</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://clodfisher.github.io/2018/09/nf_conntrack/">Iptables之nf_conntrack模块</a></li>
</ul></li>
</ul>
<h4 id="重启系统">1.3.4 重启系统</h4>
<ul>
<li><p>重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ reboot</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="下载二进制包">1.4 下载二进制包</h3>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/zh-cn/releases/download/" class="uri">https://kubernetes.io/zh-cn/releases/download/</a></p>
<p>从官方发布地址下载二进制包，下载 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.27.md#server-binaries">Server Binaries</a> 即可，这个包含了所有所需的二进制文件。</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.27.md" class="uri">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.27.md</a></p>
<p>解压后，复制二进制 <code>kube-apiserver,kube-controller-manager,kubectl,kubelet,kube-proxy,kube-scheduler</code> 到 master 节点 <code>/usr/local/bin</code> 目录下，复制二进制 <code>kubelet,kube-proxy</code> 到 worker 节点 <code>/usr/local/bin</code> 目录下。</p>
<p>在 master1 节点执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span></span><br><span class="line">➜ wget -c https://dl.k8s.io/v1.27.3/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">➜ tar -zxf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 master1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ cp kubernetes/server/bin/&#123;kubeadm,kube-apiserver,kube-controller-manager,kubectl,kubelet,kube-proxy,kube-scheduler&#125; /usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看复制结果</span></span><br><span class="line">➜ ls -lh /usr/local/bin/kube*</span><br><span class="line"></span><br><span class="line">-rwxr-xr-x 1 root root  46M Jul 10 14:28 /usr/local/bin/kubeadm</span><br><span class="line">-rwxr-xr-x 1 root root 112M Jul 10 14:28 /usr/local/bin/kube-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root 104M Jul 10 14:28 /usr/local/bin/kube-controller-manager</span><br><span class="line">-rwxr-xr-x 1 root root  47M Jul 10 14:28 /usr/local/bin/kubectl</span><br><span class="line">-rwxr-xr-x 1 root root 102M Jul 10 14:28 /usr/local/bin/kubelet</span><br><span class="line">-rwxr-xr-x 1 root root  51M Jul 10 14:28 /usr/local/bin/kube-proxy</span><br><span class="line">-rwxr-xr-x 1 root root  52M Jul 10 14:28 /usr/local/bin/kube-scheduler</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp kubernetes/server/bin/&#123;kubelet,kube-proxy&#125; root@worker1:/usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker2 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp kubernetes/server/bin/&#123;kubelet,kube-proxy&#125; root@worker2:/usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker3 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp kubernetes/server/bin/&#123;kubelet,kube-proxy&#125; root@worker3:/usr/local/bin</span><br></pre></td></tr></table></figure>
<h3 id="查看镜像版本">1.5 查看镜像版本</h3>
<p>在 master1 节点执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看依赖的镜像版本</span></span><br><span class="line">➜ kubeadm config images list</span><br><span class="line"></span><br><span class="line">registry.k8s.io/kube-apiserver:v1.27.3</span><br><span class="line">registry.k8s.io/kube-controller-manager:v1.27.3</span><br><span class="line">registry.k8s.io/kube-scheduler:v1.27.3</span><br><span class="line">registry.k8s.io/kube-proxy:v1.27.3</span><br><span class="line">registry.k8s.io/pause:3.9</span><br><span class="line">registry.k8s.io/etcd:3.5.7-0</span><br><span class="line">registry.k8s.io/coredns/coredns:v1.10.1</span><br></pre></td></tr></table></figure>
<h2 id="容器运行时">2. 容器运行时</h2>
<p>本节概述了使用 containerd 作为 CRI 运行时的必要步骤。</p>
<p><strong><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.51cto.com/lajifeiwomoshu/5428345" class="uri">https://blog.51cto.com/lajifeiwomoshu/5428345</a></strong></p>
<h3 id="安装-containerd">2.1 安装 containerd</h3>
<p>参考 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">Getting started with containerd</a> 在各节点安装 containerd。</p>
<ul>
<li><p>设置 repository</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 yum-utils</span></span><br><span class="line">➜ yum install -y yum-utils</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 repository</span></span><br><span class="line">➜ yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 repository</span></span><br><span class="line">➜ dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></li>
<li><p>查看当前镜像源中支持的 containerd 版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ yum list containerd.io --showduplicates</span><br></pre></td></tr></table></figure></li>
<li><p>安装特定版本的 containerd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ yum install -y --setopt=obsoletes=0 containerd.io-1.6.21</span><br></pre></td></tr></table></figure></li>
<li><p>添加 containerd 配置</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd" class="uri">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/cri/config.md" class="uri">https://github.com/containerd/containerd/blob/main/docs/cri/config.md</a></p>
<blockquote>
<p>This document provides the description of the CRI plugin configuration. The CRI plugin config is part of the containerd config (default path: <code>/etc/containerd/config.toml</code>).</p>
<p>See <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/ops.md">here</a> for more information about containerd config.</p>
<p>Note that the <code>[plugins."io.containerd.grpc.v1.cri"]</code> section is specific to CRI, and not recognized by other containerd clients such as <code>ctr</code>, <code>nerdctl</code>, and Docker/Moby.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 containerd 配置文件</span></span><br><span class="line">➜ cat &gt; /etc/containerd/config.toml &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/containerd/containerd/blob/main/docs/cri/config.md</span></span><br><span class="line">disabled_plugins = []</span><br><span class="line">imports = []</span><br><span class="line">version = 2</span><br><span class="line"></span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br><span class="line">  sandbox_image = &quot;registry.k8s.io/pause:3.9&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/containerd/containerd/issues/6964</span></span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br><span class="line">  runtime_type = &quot;io.containerd.runc.v2&quot;</span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br><span class="line">  SystemdCgroup = true</span><br><span class="line">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br><span class="line">  config_path = &quot;/etc/containerd/certs.d&quot;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建镜像仓库配置目录</span></span><br><span class="line">➜ mkdir -p /etc/containerd/certs.d</span><br></pre></td></tr></table></figure></li>
<li><p>启动 containerd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line">➜ systemctl enable --now containerd</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 containerd 状态</span></span><br><span class="line">➜ systemctl status containerd</span><br></pre></td></tr></table></figure></li>
<li><p>查看当前 containerd 使用的配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ containerd config dump</span><br></pre></td></tr></table></figure></li>
<li><p>测试 containerd（在任意一个集群节点测试即可）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取 redis 镜像</span></span><br><span class="line">➜ ctr images pull docker.io/library/redis:alpine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 redis 容器并运行</span></span><br><span class="line">➜ ctr run docker.io/library/redis:alpine redis</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 redis 镜像</span></span><br><span class="line">➜ ctr images delete docker.io/library/redis:alpine</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装-containerd-cli-工具">2.2 安装 containerd cli 工具</h3>
<p>There are several command line interface (CLI) projects for interacting with containerd:</p>
<table>
<colgroup>
<col style="width: 7%">
<col style="width: 18%">
<col style="width: 5%">
<col style="width: 15%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th>Name</th>
<th>Community</th>
<th>API</th>
<th>Target</th>
<th>Web site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>ctr</code></td>
<td>containerd</td>
<td>Native</td>
<td>For debugging only</td>
<td>(None, see <code>ctr --help</code> to learn the usage)</td>
</tr>
<tr class="even">
<td><code>nerdctl</code></td>
<td>containerd (non-core)</td>
<td>Native</td>
<td>General-purpose</td>
<td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/nerdctl" class="uri">https://github.com/containerd/nerdctl</a></td>
</tr>
<tr class="odd">
<td><code>crictl</code></td>
<td>Kubernetes SIG-node</td>
<td>CRI</td>
<td>For debugging only</td>
<td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md" class="uri">https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md</a></td>
</tr>
</tbody>
</table>
<h4 id="ctr">2.2.1 ctr</h4>
<p>While the <code>ctr</code> tool is bundled together with containerd, it should be noted the <code>ctr</code> tool is solely made for debugging containerd. The <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/nerdctl"><code>nerdctl</code></a> tool provides stable and human-friendly user experience.</p>
<h4 id="crictl">2.2.2 crictl</h4>
<p>crictl 是 CRI 兼容的容器运行时命令行接口，可以使用它来检查和调试 k8s 节点上的容器运行时和应用程序。主要是用于 kubernetes， 默认操作的命名空间是 k8s.io，而且看到的对象是 pod。</p>
<p>如果是 k8s 环境的话，可以参考下方链接，在每个节点部署 containerd 的时候也部署下 crictl 工具。</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kubernetes-sigs/cri-tools">kubernetes-sigs/cri-tools: CLI and validation tools for Kubelet Container Runtime Interface (CRI) .</a></p>
<p>在 master1 节点执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span></span><br><span class="line">➜ wget -c https://hub.gitmirror.com/https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.27.1/crictl-v1.27.1-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压到 master1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ tar -zxvf crictl-v1.27.1-linux-amd64.tar.gz -C /usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp /usr/local/bin/crictl root@worker1:/usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker2 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp /usr/local/bin/crictl root@worker2:/usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker3 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp /usr/local/bin/crictl root@worker3:/usr/local/bin</span><br></pre></td></tr></table></figure>
<p>创建 crictl 配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span><br><span class="line">runtime-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">timeout: 30</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br><span class="line">➜ scp /etc/crictl.yaml root@worker1:/etc</span><br><span class="line">➜ scp /etc/crictl.yaml root@worker2:/etc</span><br><span class="line">➜ scp /etc/crictl.yaml root@worker3:/etc</span><br></pre></td></tr></table></figure>
<p>测试 crictl 工具：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ crictl info --output go-template --template &#x27;&#123;&#123;.config.sandboxImage&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">registry.k8s.io/pause:3.9</span><br><span class="line"></span><br><span class="line">➜ crictl inspecti --output go-template --template &#x27;&#123;&#123;.status.pinned&#125;&#125;&#x27; registry.k8s.io/pause:3.9</span><br><span class="line"></span><br><span class="line">FATA[0000] no such image &quot;registry.k8s.io/pause:3.9&quot; present</span><br></pre></td></tr></table></figure>
<h4 id="nerdctl推荐">2.2.3 nerdctl（推荐）</h4>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/nerdctl" class="uri">https://github.com/containerd/nerdctl</a></p>
<p>对于单机节点来说，推荐使用 nerdctl，使用起来和 docker 类似，基本没学习成本，把 docker 换成 nerdctl 即可。对于普通用户来说，这个是比较友好的工具。但是对于 api 那些来说，可以选择其他。</p>
<p>nerdctl 有两种版本：</p>
<ul>
<li>Minimal (<code>nerdctl-1.4.0-linux-amd64.tar.gz</code>): nerdctl only</li>
<li>Full (<code>nerdctl-full-1.4.0-linux-amd64.tar.gz</code>): Includes dependencies such as containerd, runc, and CNI</li>
</ul>
<p>这里我选择的是 Minimal 的版本，直接到 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/nerdctl/releases" class="uri">https://github.com/containerd/nerdctl/releases</a> 下载。</p>
<p>在 master1 节点执行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span></span><br><span class="line">➜ wget -c https://hub.gitmirror.com/https://github.com/containerd/nerdctl/releases/download/v1.4.0/nerdctl-1.4.0-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压到 master1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ tar Cxzvvf /usr/local/bin nerdctl-1.4.0-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp /usr/local/bin/&#123;containerd-rootless-setuptool.sh,containerd-rootless.sh,nerdctl&#125; root@worker1:/usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker2 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp /usr/local/bin/&#123;containerd-rootless-setuptool.sh,containerd-rootless.sh,nerdctl&#125; root@worker2:/usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 worker3 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ scp /usr/local/bin/&#123;containerd-rootless-setuptool.sh,containerd-rootless.sh,nerdctl&#125; root@worker3:/usr/local/bin</span><br></pre></td></tr></table></figure>
<p>测试 nerdctl（在任意一个集群节点测试即可）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">➜ nerdctl image pull redis:alpine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像</span></span><br><span class="line">➜ nerdctl image ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除镜像</span></span><br><span class="line">➜ nerdctl image rm redis:alpine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行 nginx 服务（需要 CNI plugin）</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ nerdctl run -d --name nginx -p 80:80 nginx:alpine</span></span><br></pre></td></tr></table></figure>
<h3 id="设置公共仓库镜像源可选">2.3 设置公共仓库镜像源（可选）</h3>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/cri/registry.md" class="uri">https://github.com/containerd/containerd/blob/main/docs/cri/registry.md</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/hosts.md" class="uri">https://github.com/containerd/containerd/blob/main/docs/hosts.md</a></p>
<p>由于某些因素，在国内拉取公共镜像仓库的速度是极慢的，为了节约拉取时间，需要为 containerd 配置镜像仓库的 mirror。</p>
<p>containerd 的镜像仓库 mirror 与 docker 相比有两个区别：</p>
<ul>
<li><p>containerd 只支持通过 CRI 拉取镜像的 mirror，也就是说，只有通过 crictl，nerdctl 或者 kubernetes 调用时 mirror 才会生效，要想使用 ctr 拉取也生效的话需要指定 <code>--hosts-dir</code>。</p>
<blockquote>
<p>可以通过 <code>nerdctl --debug pull</code> 来观察</p>
</blockquote></li>
<li><p>docker 只支持为 Docker Hub 配置 mirror，而 containerd 支持为任意镜像仓库配置 mirror。</p>
<blockquote>
<p>registry.aliyuncs.com/google_containers 虽然有 k8s.gcr.io 的镜像，但不是加速站点</p>
</blockquote></li>
</ul>
<p>拉取镜像时，默认都是从 docker hub 上拉取，如果镜像名前不加 registry 地址的话默认会给你加上 <code>docker.io/library</code>。</p>
<p>需要注意的是：</p>
<ul>
<li>如果 hosts.toml 文件中的 capabilities 中不加 resolve 的话，无法加速镜像</li>
<li>配置无需重启服务，即可生效</li>
<li>要配保底的加速站点，否则可能会导致下载失败</li>
</ul>
<h4 id="docker.io">2.3.1 docker.io</h4>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://yeasy.gitbook.io/docker_practice/install/mirror" class="uri">https://yeasy.gitbook.io/docker_practice/install/mirror</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 docker.io 目录</span></span><br><span class="line">➜ mkdir -p /etc/containerd/certs.d/docker.io</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 docker.io 仓库配置文件</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://blog.csdn.net/qq_44797987/article/details/112681224</span></span><br><span class="line">server = &quot;https://docker.io&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;https://dockerproxy.com&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">[host.&quot;https://ccr.ccs.tencentyun.com&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">[host.&quot;https://hub-mirror.c.163.com&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">[host.&quot;https://mirror.baidubce.com&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">[host.&quot;https://registry-1.docker.io&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;, &quot;push&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h4 id="registry.k8s.io">2.3.2 registry.k8s.io</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 registry.k8s.io 目录</span></span><br><span class="line">➜ mkdir -p /etc/containerd/certs.d/registry.k8s.io</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 registry.k8s.io 仓库配置文件</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/registry.k8s.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://registry.k8s.io&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;https://registry.aliyuncs.com/v2/google_containers&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">  override_path = true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>registry.aliyuncs.com/google_containers 这个镜像仓库站点不是 registry.k8s.io 的 mirror，只是有 registry.k8s.io 的镜像，这就是为什么 registry.k8s.io 有些镜像在 registry.aliyuncs.com/google_containers 没有的原因。</p>
<p>通过执行以下命令并观察输出可以知道，从 "registry.aliyuncs.com/google_containers" 拉取 pause 镜像正确的请求是 "<a target="_blank" rel="external nofollow noopener noreferrer" href="https://registry.cn-hangzhou.aliyuncs.com/v2/google_containers/pause/manifests/3.9" class="uri">https://registry.cn-hangzhou.aliyuncs.com/v2/google_containers/pause/manifests/3.9</a>"。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 master1 节点进行测试</span></span><br><span class="line">➜ ctr --debug images pull -k registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">DEBU[0000] do request                                    host=registry.cn-hangzhou.aliyuncs.com request.header.accept=&quot;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&quot; request.header.user-agent=containerd/1.6.21 request.method=HEAD url=&quot;https://registry.cn-hangzhou.aliyuncs.com/v2/google_containers/pause/manifests/3.9&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>使用 ctr 命令拉取 "registry.k8s.io/pause:3.9" 镜像，如果最终拼接出的请求不是 "<a target="_blank" rel="external nofollow noopener noreferrer" href="https://registry.cn-hangzhou.aliyuncs.com/v2/google_containers/pause/manifests/3.9" class="uri">https://registry.cn-hangzhou.aliyuncs.com/v2/google_containers/pause/manifests/3.9</a>"，则会导致拉取失败。</p>
<p>根据文档 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/hosts.md" class="uri">https://github.com/containerd/containerd/blob/main/docs/hosts.md</a> 可以知道：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pull [registry_host_name|IP address][:port][/v2][/org_path]&lt;image_name&gt;[:tag|@DIGEST]</span><br></pre></td></tr></table></figure>
<p>拉取请求格式的 <code>/v2</code> 部分指的是分发 api 的版本。 如果未包含在拉取请求中，则默认情况下为符合上面链接的分发规范的所有客户端添加 <code>/v2</code>。这可能会导致不合规的 OCI registry 使用有问题。</p>
<p>以拉取 "registry.k8s.io/pause:3.9" 镜像为例，<strong>在 master1 节点上进行测试</strong>，分析几种配置情况下实际的拉取请求 URL 及拉取结果：</p>
<h5 id="配置一错误">2.3.2.1 配置一（错误）</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 registry.k8s.io 配置</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/registry.k8s.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://registry.k8s.io&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;https://registry.aliyuncs.com/google_containers&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试镜像拉取</span></span><br><span class="line">➜ ctr --debug images pull --hosts-dir &quot;/etc/containerd/certs.d&quot; registry.k8s.io/pause:3.9</span><br><span class="line"></span><br><span class="line">DEBU[0000] fetching                                      image=&quot;registry.k8s.io/pause:3.9&quot;</span><br><span class="line">DEBU[0000] loading host directory                        dir=/etc/containerd/certs.d/registry.k8s.io</span><br><span class="line">DEBU[0000] resolving                                     host=registry.aliyuncs.com</span><br><span class="line">DEBU[0000] do request                                    host=registry.aliyuncs.com request.header.accept=&quot;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&quot; request.header.user-agent=containerd/1.6.21 request.method=HEAD url=&quot;https://registry.aliyuncs.com/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] fetch response received                       host=registry.aliyuncs.com response.header.content-length=19 response.header.content-type=&quot;text/plain; charset=utf-8&quot; response.header.date=&quot;Wed, 12 Jul 2023 14:40:38 GMT&quot; response.header.docker-distribution-api-version=registry/2.0 response.header.x-content-type-options=nosniff response.status=&quot;404 Not Found&quot; url=&quot;https://registry.aliyuncs.com/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">INFO[0000] trying next host - response was http.StatusNotFound  host=registry.aliyuncs.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>由输出可知，因为实际请求的 URL "<a target="_blank" rel="external nofollow noopener noreferrer" href="https://registry.aliyuncs.com/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io" class="uri">https://registry.aliyuncs.com/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io</a>" 不正确，所以拉取失败。</p>
<h5 id="配置二错误">2.3.2.2 配置二（错误）</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 registry.k8s.io 配置</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/registry.k8s.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://registry.k8s.io&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;https://registry.aliyuncs.com/v2/google_containers&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试镜像拉取</span></span><br><span class="line">➜ ctr --debug images pull --hosts-dir &quot;/etc/containerd/certs.d&quot; registry.k8s.io/pause:3.9</span><br><span class="line"></span><br><span class="line">DEBU[0000] fetching                                      image=&quot;registry.k8s.io/pause:3.9&quot;</span><br><span class="line">DEBU[0000] loading host directory                        dir=/etc/containerd/certs.d/registry.k8s.io</span><br><span class="line">DEBU[0000] resolving                                     host=registry.aliyuncs.com</span><br><span class="line">DEBU[0000] do request                                    host=registry.aliyuncs.com request.header.accept=&quot;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&quot; request.header.user-agent=containerd/1.6.21 request.method=HEAD url=&quot;https://registry.aliyuncs.com/v2/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] fetch response received                       host=registry.aliyuncs.com response.header.content-length=169 response.header.content-type=&quot;application/json; charset=utf-8&quot; response.header.date=&quot;Wed, 12 Jul 2023 15:02:21 GMT&quot; response.header.docker-distribution-api-version=registry/2.0 response.header.www-authenticate=&quot;Bearer realm=\&quot;https://dockerauth.cn-hangzhou.aliyuncs.com/auth\&quot;,service=\&quot;registry.aliyuncs.com:cn-hangzhou:26842\&quot;,scope=\&quot;repository:google_containers/v2/pause:pull\&quot;&quot; response.status=&quot;401 Unauthorized&quot; url=&quot;https://registry.aliyuncs.com/v2/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] Unauthorized                                  header=&quot;Bearer realm=\&quot;https://dockerauth.cn-hangzhou.aliyuncs.com/auth\&quot;,service=\&quot;registry.aliyuncs.com:cn-hangzhou:26842\&quot;,scope=\&quot;repository:google_containers/v2/pause:pull\&quot;&quot; host=registry.aliyuncs.com</span><br><span class="line">DEBU[0000] do request                                    host=registry.aliyuncs.com request.header.accept=&quot;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&quot; request.header.user-agent=containerd/1.6.21 request.method=HEAD url=&quot;https://registry.aliyuncs.com/v2/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] fetch response received                       host=registry.aliyuncs.com response.header.content-length=169 response.header.content-type=&quot;application/json; charset=utf-8&quot; response.header.date=&quot;Wed, 12 Jul 2023 15:02:21 GMT&quot; response.header.docker-distribution-api-version=registry/2.0 response.header.www-authenticate=&quot;Bearer realm=\&quot;https://dockerauth.cn-hangzhou.aliyuncs.com/auth\&quot;,service=\&quot;registry.aliyuncs.com:cn-hangzhou:26842\&quot;,scope=\&quot;repository:google_containers/v2/pause:pull\&quot;,error=\&quot;insufficient_scope\&quot;&quot; response.status=&quot;401 Unauthorized&quot; url=&quot;https://registry.aliyuncs.com/v2/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] Unauthorized                                  header=&quot;Bearer realm=\&quot;https://dockerauth.cn-hangzhou.aliyuncs.com/auth\&quot;,service=\&quot;registry.aliyuncs.com:cn-hangzhou:26842\&quot;,scope=\&quot;repository:google_containers/v2/pause:pull\&quot;,error=\&quot;insufficient_scope\&quot;&quot; host=registry.aliyuncs.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>由输出可知，因为实际请求的 URL "<a target="_blank" rel="external nofollow noopener noreferrer" href="https://registry.aliyuncs.com/v2/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io" class="uri">https://registry.aliyuncs.com/v2/google_containers/v2/pause/manifests/3.9?ns=registry.k8s.io</a>" 不正确，所以拉取失败。</p>
<h5 id="配置三正确">2.3.2.3 配置三（正确）</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 registry.k8s.io 配置</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/registry.k8s.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://registry.k8s.io&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;https://registry.aliyuncs.com/v2/google_containers&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">  override_path = true</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试镜像拉取</span></span><br><span class="line">➜ ctr --debug images pull --hosts-dir &quot;/etc/containerd/certs.d&quot; registry.k8s.io/pause:3.9</span><br><span class="line"></span><br><span class="line">DEBU[0000] fetching                                      image=&quot;registry.k8s.io/pause:3.9&quot;</span><br><span class="line">DEBU[0000] loading host directory                        dir=/etc/containerd/certs.d/registry.k8s.io</span><br><span class="line">DEBU[0000] resolving                                     host=registry.aliyuncs.com</span><br><span class="line">DEBU[0000] do request                                    host=registry.aliyuncs.com request.header.accept=&quot;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&quot; request.header.user-agent=containerd/1.6.21 request.method=HEAD url=&quot;https://registry.aliyuncs.com/v2/google_containers/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] fetch response received                       host=registry.aliyuncs.com response.header.content-length=166 response.header.content-type=&quot;application/json; charset=utf-8&quot; response.header.date=&quot;Wed, 12 Jul 2023 15:04:06 GMT&quot; response.header.docker-distribution-api-version=registry/2.0 response.header.www-authenticate=&quot;Bearer realm=\&quot;https://dockerauth.cn-hangzhou.aliyuncs.com/auth\&quot;,service=\&quot;registry.aliyuncs.com:cn-hangzhou:26842\&quot;,scope=\&quot;repository:google_containers/pause:pull\&quot;&quot; response.status=&quot;401 Unauthorized&quot; url=&quot;https://registry.aliyuncs.com/v2/google_containers/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] Unauthorized                                  header=&quot;Bearer realm=\&quot;https://dockerauth.cn-hangzhou.aliyuncs.com/auth\&quot;,service=\&quot;registry.aliyuncs.com:cn-hangzhou:26842\&quot;,scope=\&quot;repository:google_containers/pause:pull\&quot;&quot; host=registry.aliyuncs.com</span><br><span class="line">DEBU[0000] do request                                    host=registry.aliyuncs.com request.header.accept=&quot;application/vnd.docker.distribution.manifest.v2+json, application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.oci.image.manifest.v1+json, application/vnd.oci.image.index.v1+json, */*&quot; request.header.user-agent=containerd/1.6.21 request.method=HEAD url=&quot;https://registry.aliyuncs.com/v2/google_containers/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] fetch response received                       host=registry.aliyuncs.com response.header.content-length=2405 response.header.content-type=application/vnd.docker.distribution.manifest.list.v2+json response.header.date=&quot;Wed, 12 Jul 2023 15:04:07 GMT&quot; response.header.docker-content-digest=&quot;sha256:7031c1b283388d2c2e09b57badb803c05ebed362dc88d84b480cc47f72a21097&quot; response.header.docker-distribution-api-version=registry/2.0 response.header.etag=&quot;\&quot;sha256:7031c1b283388d2c2e09b57badb803c05ebed362dc88d84b480cc47f72a21097\&quot;&quot; response.status=&quot;200 OK&quot; url=&quot;https://registry.aliyuncs.com/v2/google_containers/pause/manifests/3.9?ns=registry.k8s.io&quot;</span><br><span class="line">DEBU[0000] resolved                                      desc.digest=&quot;sha256:7031c1b283388d2c2e09b57badb803c05ebed362dc88d84b480cc47f72a21097&quot; host=registry.aliyuncs.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>由输出可知，因为实际请求的 URL "<a target="_blank" rel="external nofollow noopener noreferrer" href="https://registry.aliyuncs.com/v2/google_containers/pause/manifests/3.9?ns=registry.k8s.io" class="uri">https://registry.aliyuncs.com/v2/google_containers/pause/manifests/3.9?ns=registry.k8s.io</a>" 正确，所以拉取成功。</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/containerd/containerd/blob/main/docs/hosts.md#override_path-field" class="uri">https://github.com/containerd/containerd/blob/main/docs/hosts.md#override_path-field</a></p>
<p><code>override_path</code> is used to indicate the host's API root endpoint is defined in the URL path rather than by the API specification. This may be used with non-compliant OCI registries which are missing the <code>/v2</code> prefix. (Defaults to <code>false</code>)</p>
<h4 id="quay.io">2.3.3 quay.io</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 quay.io 目录</span></span><br><span class="line">➜ mkdir -p /etc/containerd/certs.d/quay.io</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 quay.io 仓库配置文件</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/quay.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://quay.io&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;https://quay-mirror.qiniu.com&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="设置私有仓库可选">2.4 设置私有仓库（可选）</h3>
<h4 id="部署私有仓库">2.4.1 部署私有仓库</h4>
<p><strong>在用于测试的 registry 节点部署私有仓库，以测试 containerd 使用私有仓库的场景。</strong></p>
<h5 id="安装-docker">2.4.1.1 安装 docker</h5>
<p>参考文档 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.docker.com/engine/install/centos/">Install Docker Engine on CentOS</a>，在 registry 节点安装 docker：</p>
<ul>
<li><p>切换镜像源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 repository</span></span><br><span class="line">➜ dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></li>
<li><p>查看当前镜像源中支持的 docker 版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ yum list docker-ce --showduplicates</span><br></pre></td></tr></table></figure></li>
<li><p>安装特定版本的 docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ yum install -y --setopt=obsoletes=0 docker-ce-20.10.24</span><br></pre></td></tr></table></figure>
<p><code>--setopt=obsoletes=0</code> 是 yum 包管理器的一个选项，它的作用是禁用软件包依赖关系中的版本升级。</p></li>
<li><p>添加配置文件</p>
<p>docker 在默认情况下使用的 cgroup driver 为 cgroupfs，而 kubernetes 推荐使用 systemd 来替代 cgroupfs。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ mkdir /etc/docker</span><br><span class="line">➜ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://mirror.baidubce.com&quot;, &quot;https://hub-mirror.c.163.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li>
<li><p>启动 dokcer</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line">➜ systemctl enable --now docker</span><br><span class="line">➜ systemctl status docker</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="部署-registry">2.4.1.2 部署 registry</h5>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.docker.com/registry/deploying/" class="uri">https://docs.docker.com/registry/deploying/</a></p>
<ul>
<li><p>拉取 registry 镜像</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hub.docker.com/_/registry" class="uri">https://hub.docker.com/_/registry</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ docker pull registry:2.8.1</span><br></pre></td></tr></table></figure></li>
<li><p>创建 registry 数据目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ mkdir /data</span><br></pre></td></tr></table></figure></li>
<li><p>运行 registry 服务</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://yeasy.gitbook.io/docker_practice/repository/registry" class="uri">https://yeasy.gitbook.io/docker_practice/repository/registry</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ docker run -d \</span><br><span class="line">    --name registry.local \</span><br><span class="line">    --publish 5000:5000 \</span><br><span class="line">    --restart always \</span><br><span class="line">    --volume /data:/var/lib/registry \</span><br><span class="line">    registry:2.8.1</span><br></pre></td></tr></table></figure></li>
<li><p>拉取、推送测试镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">➜ docker pull redis:alpine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">标记镜像</span></span><br><span class="line">➜ docker tag redis:alpine registry.local:5000/redis:alpine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送镜像</span></span><br><span class="line">➜ docker push registry.local:5000/redis:alpine</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像</span></span><br><span class="line">➜ curl registry.local:5000/v2/_catalog</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="registry.local">2.4.2 registry.local</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 registry.local 目录</span></span><br><span class="line">➜ mkdir -p /etc/containerd/certs.d/registry.local</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 registry.local 仓库配置文件</span></span><br><span class="line">➜ cat &gt; /etc/containerd/certs.d/registry.local/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://registry.local&quot;</span><br><span class="line"></span><br><span class="line">[host.&quot;http://registry.local:5000&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;, &quot;push&quot;]</span><br><span class="line">  skip_verify = true</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">追加 /etc/hosts 配置</span></span><br><span class="line">➜ cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">10.128.170.235 registry.local</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h4 id="测试私有仓库">2.4.3 测试私有仓库</h4>
<p>在任意一个集群节点测试即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">➜ ctr --debug images pull --hosts-dir &quot;/etc/containerd/certs.d&quot; registry.local/redis:alpine</span><br></pre></td></tr></table></figure>
<p>需要注意的是：</p>
<ul>
<li><p><code>ctr image pull</code> 的时候需要注意镜像名称需要完整，否则无法拉取，格式如下：</p>
<p><code>[registry_host_name|IP address][:port][/v2][/org_path]&lt;image_name&gt;[:tag|@DIGEST]</code></p></li>
<li><p>因为 ctr 不使用 CRI，所以默认不会使用 config.toml 中 cri 的配置，如果拉取镜像时希望使用 mirror，则需要指定 <code>--hosts-dir</code>。</p></li>
</ul>
<h2 id="创建-ca-证书">3. 创建 ca 证书</h2>
<p><strong>证书操作如无特殊说明，只需在 master1 节点执行即可。</strong></p>
<h3 id="安装-cfssl">3.1 安装 cfssl</h3>
<p>cfssl 是一款证书签署工具，使用 cfssl 工具可以很简化证书签署过程，方便颁发自签证书。</p>
<p>CloudFlare's distributes <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/cloudflare/cfssl">cfssl</a> source code on github page and binaries on <a target="_blank" rel="external nofollow noopener noreferrer" href="https://pkg.cfssl.org/">cfssl website</a>.</p>
<p>Our documentation assumes that you will run <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/cloudflare/cfssl">cfssl</a> on your local x86_64 Linux host.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/cloudflare/cfssl/releases/tag/v1.6.4" class="uri">https://github.com/cloudflare/cfssl/releases/tag/v1.6.4</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载并重命名</span></span><br><span class="line">➜ curl -L -o https://download.nuaa.cf/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64</span><br><span class="line">➜ curl -L -o /usr/local/bin/cfssljson https://download.nuaa.cf/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">赋予可执行权限</span></span><br><span class="line">➜ chmod +x /usr/local/bin/&#123;cfssl,cfssljson&#125;</span><br></pre></td></tr></table></figure>
<p>离线安装的情况，直接把两个文件下载下来重命名即可。</p>
<h3 id="创建-ca-证书-1">3.2 创建 ca 证书</h3>
<p>创建的证书统一放到 /etc/kubernetes/ssl 目录，创建后复制到 /etc/kubernetes/pki 目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ mkdir -p /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ca 证书创建申请</span></span><br><span class="line">➜ cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 ca 证书</span></span><br><span class="line">➜ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh ca*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 13 12:38 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.4K Jul 13 12:38 ca.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 ca 证书到 /etc/kubernetes/pki</span></span><br><span class="line">➜ cp ca*pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>
<p>ca-csr.json 这个文件是 Kubernetes 集群中使用的根证书的签名请求 (CSR) 配置文件，用于定义 CA 证书的签名请求配置。</p>
<p>在这个配置文件中，CN 字段指定了证书的通用名称为 "kubernetes"，key 字段指定了证书的密钥算法为 RSA，密钥长度为 2048 位。names 字段定义了证书的其他信息，如国家、省份、城市、组织和组织单位等。ca 字段指定了证书的过期时间为 87600 小时（即 10 年）。</p>
<p>这个配置文件用于创建 Kubernetes 集群中的 CA 证书，以便对集群中的其他证书进行签名和认证。</p>
<ul>
<li>CN(Common Name): kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)</li>
<li>names[].O(Organization): kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)</li>
</ul>
<p>由于这里是 CA 证书，是签发其它证书的根证书，这个证书密钥不会分发出去作为 client 证书，所有组件使用的 client 证书都是由 CA 证书签发而来，所以 CA 证书的 CN 和 O 的名称并不重要，后续其它签发出来的证书的 CN 和 O 的名称才是有用的。</p>
<h3 id="创建签发配置文件">3.3 创建签发配置文件</h3>
<p>由于各个组件都需要配置证书，并且依赖 CA 证书来签发证书，所以我们首先要生成好 CA 证书以及后续的签发配置文件。</p>
<p>创建用于签发其它证书的配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">证书签发配置文件</span></span><br><span class="line">➜ cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;kubernetes&quot;: &#123;</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>ca-config.json 这个文件是签发其它证书的配置文件，用于定义签名配置和证书配置。其中，signing 字段定义了签名配置，profiles 字段定义了不同场景下的证书配置。</p>
<p>在这个配置文件中，default 配置指定了默认的证书过期时间为 87600 小时（即 10 年），profiles 配置定义了一个名为 "kubernetes" 的证书配置，它指定了证书的用途（签名、密钥加密、服务器认证和客户端认证）和过期时间。</p>
<p>这个配置文件用于创建 Kubernetes 集群中的证书和密钥，以便对集群进行安全认证和加密通信。</p>
<ul>
<li>signing：定义了签名配置，包括默认的签名过期时间和各个证书配置的签名过期时间。</li>
<li>profiles：定义了不同场景下的证书配置，包括证书的用途、过期时间和其他属性。</li>
</ul>
<p>在使用 cfssl gencert 命令生成证书时，可以使用 <code>-config</code> 参数指定配置文件，以便根据配置文件中的规则生成符合要求的证书。如果不指定 <code>-config</code> 参数，则 cfssl gencert 命令将使用默认的配置文件。</p>
<h2 id="部署-etcd">4. 部署 etcd</h2>
<p>根据 kubeadm 获取的信息，在 Kubernetes 1.27.3 版本中 etcd 使用的版本是 3.5.7，<strong>只需在 master 节点（也即 master1 节点）部署即可</strong>。</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/etcd-io/etcd/releases/tag/v3.5.7" class="uri">https://github.com/etcd-io/etcd/releases/tag/v3.5.7</a></p>
<h3 id="颁发证书">4.1 颁发证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">etcd 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有 etcd 集群节点地址，这里可以做好规划，预留几个 IP，以备后续扩容。</span></span><br><span class="line">➜ cat &gt; etcd-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.128.170.21&quot;,</span><br><span class="line">        &quot;10.128.170.22&quot;,</span><br><span class="line">        &quot;10.128.170.23&quot;,</span><br><span class="line">        &quot;localhost&quot;,</span><br><span class="line">        &quot;master1&quot;,</span><br><span class="line">        &quot;master2&quot;,</span><br><span class="line">        &quot;master3&quot;,</span><br><span class="line">        &quot;master1.local&quot;,</span><br><span class="line">        &quot;master2.local&quot;,</span><br><span class="line">        &quot;master3.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 etcd 证书</span></span><br><span class="line">➜ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh etcd*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 13 23:35 etcd-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.6K Jul 13 23:35 etcd.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 etcd 证书到 /etc/kubernetes/pki</span></span><br><span class="line">➜ cp etcd*pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>
<h3 id="部署-etcd-1">4.2 部署 etcd</h3>
<p>下载二进制包 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/etcd-io/etcd/releases/tag/v3.5.7" class="uri">https://github.com/etcd-io/etcd/releases/tag/v3.5.7</a> 并解压，将二进制程序 <code>etcd</code> 和 <code>etcdctl</code> 复制到 <code>/usr/local/bin</code> 目录下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span></span><br><span class="line">➜ wget -c https://hub.gitmirror.com/https://github.com/etcd-io/etcd/releases/download/v3.5.7/etcd-v3.5.7-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">➜ tar -zxf etcd-v3.5.7-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 master1 节点 /usr/local/bin 目录</span></span><br><span class="line">➜ cp etcd-v3.5.7-linux-amd64/&#123;etcd,etcdctl&#125; /usr/local/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看复制结果</span></span><br><span class="line">➜ ls -lh /usr/local/bin/etcd*</span><br><span class="line"></span><br><span class="line">-rwxr-xr-x 1 root root 22M Jul 13 23:49 /usr/local/bin/etcd</span><br><span class="line">-rwxr-xr-x 1 root root 17M Jul 13 23:49 /usr/local/bin/etcdctl</span><br></pre></td></tr></table></figure>
<p>编写服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜ mkdir /etc/etcd</span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/etcd/etcd.conf &lt;&lt; EOF</span><br><span class="line">ETCD_NAME=&quot;etcd1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://10.128.170.21:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://10.128.170.21:2379&quot;</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://10.128.170.21:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://10.128.170.21:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://10.128.170.21:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>配置文件解释：</p>
<ul>
<li><code>ETCD_NAME</code>：节点名称，集群中唯一</li>
<li><code>ETCD_DATA_DIR</code>： 数据保存目录</li>
<li><code>ETCD_LISTEN_PEER_URLS</code>：集群内部通信监听地址</li>
<li><code>ETCD_LISTEN_CLIENT_URLS</code>：客户端访问监听地址</li>
<li><code>ETCD_INITIAL_ADVERTISE_PEER_URLS</code>：集群通告地址</li>
<li><code>ETCD_ADVERTISE_CLIENT_URLS</code>：客户端通告地址</li>
<li><code>ETCD_INITIAL_CLUSTER</code>：集群节点地址列表</li>
<li><code>ETCD_INITIAL_CLUSTER_TOKEN</code>：集群通信 token</li>
<li><code>ETCD_INITIAL_CLUSTER_STATE</code>：加入集群的当前状态，new 是新集群，existing 表示加入已有集群</li>
</ul>
<p>编写服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建数据目录</span></span><br><span class="line">➜ mkdir -p /var/lib/etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建系统服务</span></span><br><span class="line">➜ cat &gt; /lib/systemd/system/etcd.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/etcd/etcd.conf</span><br><span class="line">WorkingDirectory=/var/lib/etcd</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">  --cert-file=/etc/kubernetes/pki/etcd.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/pki/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/kubernetes/pki/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/kubernetes/pki/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动 etcd 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u etcd</span><br></pre></td></tr></table></figure>
<h2 id="部署-kube-apiserver">5. 部署 kube-apiserver</h2>
<p><strong>只需在 master 节点（也即 master1 节点）部署即可。</strong></p>
<h3 id="颁发证书-1">5.1 颁发证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-apiserver 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有 kube-apiserver 节点地址，这里可以做好规划，预留几个 IP，以备后续扩容。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.96.0.1 是 service 网段的第一个 IP</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubernetes.default.svc.cluster.local 是 kube-apiserver 的 service 域名</span></span><br><span class="line">➜ cat &gt; kube-apiserver-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.128.170.21&quot;,</span><br><span class="line">        &quot;10.128.170.22&quot;,</span><br><span class="line">        &quot;10.128.170.23&quot;,</span><br><span class="line">        &quot;10.96.0.1&quot;,</span><br><span class="line">        &quot;localhost&quot;,</span><br><span class="line">        &quot;master1&quot;,</span><br><span class="line">        &quot;master2&quot;,</span><br><span class="line">        &quot;master3&quot;,</span><br><span class="line">        &quot;master1.local&quot;,</span><br><span class="line">        &quot;master2.local&quot;,</span><br><span class="line">        &quot;master3.local&quot;,</span><br><span class="line">        &quot;kubernetes&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-apiserver 证书</span></span><br><span class="line">➜ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh kube-apiserver*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 14 00:07 kube-apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.8K Jul 14 00:07 kube-apiserver.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-apiserver 证书到 /etc/kubernetes/pki</span></span><br><span class="line">➜ cp kube-apiserver*pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>
<h3 id="部署-kube-apiserver-1">5.2 部署 kube-apiserver</h3>
<p>编写服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以使用 kubeadm 生成示例配置文件，然后进行修改</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubeadm init phase control-plane apiserver --dry-run -v 4</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">I0717 00:13:59.260175    6660 manifests.go:154] [control-plane] wrote static Pod manifest <span class="keyword">for</span> component <span class="string">&quot;kube-apiserver&quot;</span> to <span class="string">&quot;/etc/kubernetes/tmp/kubeadm-init-dryrun365914376/kube-apiserver.yaml&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/kubernetes/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --bind-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=true \</span><br><span class="line">  --enable-bootstrap-token-auth \</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/16 \</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/kube-apiserver.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/kube-apiserver-key.pem \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/pki/kube-apiserver.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/pki/kube-apiserver-key.pem \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/pki/etcd.pem \</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/pki/etcd-key.pem \</span><br><span class="line">  --etcd-servers=https://10.128.170.21:2379 \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --apiserver-count=1 \</span><br><span class="line">  --audit-log-maxage=30 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span><br><span class="line">  --event-ttl=1h \</span><br><span class="line">  --v=4&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果 etcd 是一个集群，则 <code>--etcd-servers</code> 可以添加多个，例如：<code>--etcd-servers=https://10.128.170.21:2379,https://10.128.170.22:2379,https://10.128.170.23:2379</code></p>
</blockquote>
<p>生成 token 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /etc/kubernetes/token.csv &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(<span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">od</span> -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span>),kubelet-bootstrap,10001,<span class="string">&quot;system:node-bootstrapper&quot;</span></span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在这个命令中，<code>head -c 16 /dev/urandom | od -An -t x | tr -d ' '</code> 生成了一个 16 字节的随机字符串，并将其转换为十六进制格式。这个字符串将作为令牌的值。</p>
<ul>
<li>kubelet-bootstrap 是令牌的用户名</li>
<li>10001 是令牌的 UID，</li>
<li>system:node-bootstrapper 是令牌的组名。</li>
</ul>
<p>这些值将用于 kubelet 节点的身份验证和授权。</p>
</blockquote>
<p>编写服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动 kube-apiserver 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kube-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kube-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kube-apiserver</span><br></pre></td></tr></table></figure>
<h2 id="配置-kubectl">6. 配置 kubectl</h2>
<p>部署完 kube-apiserver 后，就可以配置 kubectl 了，因为 kubectl 可以验证 kube-apiserver 是否已经正常工作了。</p>
<p><strong>只需在 master 节点（也即 master1 节点）配置即可。</strong></p>
<h3 id="颁发证书-2">6.1 颁发证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">O 参数的值必须为 system:masters，因为这是 kube-apiserver 一个内置好的角色，拥有集群管理的权限</span></span><br><span class="line">➜ cat &gt; kubectl-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;clusteradmin&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kubectl 证书</span></span><br><span class="line">➜ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubectl-csr.json | cfssljson -bare kubectl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh kubectl*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 14 00:45 kubectl-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.4K Jul 14 00:45 kubectl.pem</span><br></pre></td></tr></table></figure>
<h3 id="生成配置文件">6.2 生成配置文件</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.128.170.21:6443 --kubeconfig=kube.config</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-credentials clusteradmin --client-certificate=kubectl.pem --client-key=kubectl-key.pem --embed-certs=true --kubeconfig=kube.config</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-context kubernetes --cluster=kubernetes --user=clusteradmin --kubeconfig=kube.config</span><br><span class="line"></span><br><span class="line">➜ kubectl config use-context kubernetes --kubeconfig=kube.config</span><br><span class="line"></span><br><span class="line">➜ mkdir ~/.kube</span><br><span class="line"></span><br><span class="line">➜ cp kube.config ~/.kube/config</span><br></pre></td></tr></table></figure>
<p>以上命令用于在本地创建一个 Kubernetes 配置文件 kube.config，并将其复制到 ~/.kube/config 文件中，以便使用 kubectl 命令与 Kubernetes 集群进行交互。</p>
<blockquote>
<p>kubectl config set-cluster 命令设置了一个名为 kubernetes 的集群，指定了以下参数：</p>
<ul>
<li><code>--certificate-authority=ca.pem</code>：指定 CA 证书文件的路径。</li>
<li><code>--embed-certs=true</code>：将 CA 证书嵌入到配置文件中。</li>
<li><code>--server=https://10.128.170.21:6443</code>：指定 API Server 的地址和端口。</li>
<li><code>--kubeconfig=kube.config</code>：指定要写入的配置文件路径。</li>
</ul>
<p>这些参数将用于创建一个名为 kubernetes 的集群配置，并将其写入到 kube.config 文件中。</p>
<p>kubectl config set-credentials 命令设置了一个名为 clusteradmin 的用户，指定了以下参数：</p>
<ul>
<li><code>--client-certificate=kubectl.pem</code>：指定客户端证书文件的路径。</li>
<li><code>--client-key=kubectl-key.pem</code>：指定客户端私钥文件的路径。</li>
<li><code>--embed-certs=true</code>：将客户端证书和私钥嵌入到配置文件中。</li>
<li><code>--kubeconfig=kube.config</code>：指定要写入的配置文件路径。</li>
</ul>
<p>这些参数将用于创建一个名为 clusteradmin 的用户配置，并将其写入到 kube.config 文件中。</p>
<p>kubectl config set-context 命令设置了一个名为 kubernetes 的上下文，指定了以下参数：</p>
<ul>
<li><code>--cluster=kubernetes</code>：指定要使用的集群。</li>
<li><code>--user=clusteradmin</code>：指定要使用的用户。</li>
<li><code>--kubeconfig=kube.config</code>：指定要写入的配置文件路径。</li>
</ul>
<p>这些参数将用于创建一个名为 kubernetes 的上下文配置，并将其写入到 kube.config 文件中。</p>
<p>kubectl config use-context 命令将当前上下文设置为 kubernetes，指定了以下参数：</p>
<ul>
<li><code>--kubeconfig=kube.config</code>：指定要使用的配置文件路径。</li>
</ul>
<p>这个命令将当前上下文设置为 kubernetes，以便 kubectl 命令可以使用 kube.config 文件与 Kubernetes 集群进行交互。</p>
</blockquote>
<h3 id="获取集群信息">6.3 获取集群信息</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl cluster-info</span><br><span class="line"></span><br><span class="line">Kubernetes control plane is running at https://10.128.170.21:6443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &#x27;kubectl cluster-info dump&#x27;.</span><br><span class="line"></span><br><span class="line">➜ kubectl get all -A</span><br><span class="line"></span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   22m</span><br><span class="line"></span><br><span class="line">➜ kubectl get cs</span><br><span class="line"></span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                        ERROR</span><br><span class="line">controller-manager   Unhealthy   Get &quot;https://127.0.0.1:10257/healthz&quot;: dial tcp 127.0.0.1:10257: connect: connection refused</span><br><span class="line">scheduler            Unhealthy   Get &quot;https://127.0.0.1:10259/healthz&quot;: dial tcp 127.0.0.1:10259: connect: connection refused</span><br><span class="line">etcd-0               Healthy     &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置-kubectl-自动补全">6.4 设置 kubectl 自动补全</h3>
<p>查看 kubectl 命令自动补全帮助：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl completion --help</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">安装 bash-completion：</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">➜ yum install -y bash-completion</span><br></pre></td></tr></table></figure>
<p>设置 kubectl 自动补全配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">使配置生效：</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">➜ source ~/.bashrc</span><br></pre></td></tr></table></figure>
<h2 id="部署-kube-controller-manager">7. 部署 kube-controller-manager</h2>
<p><strong>只需在 master 节点（也即 master1 节点）部署即可。</strong></p>
<h3 id="颁发证书-3">7.1 颁发证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-controller-manager 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有节点地址，这里可以做好规划，预留几个 IP，以备后续扩容。</span></span><br><span class="line">➜ cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.128.170.21&quot;,</span><br><span class="line">        &quot;10.128.170.22&quot;,</span><br><span class="line">        &quot;10.128.170.23&quot;,</span><br><span class="line">        &quot;10.128.170.131&quot;,</span><br><span class="line">        &quot;10.128.170.132&quot;,</span><br><span class="line">        &quot;10.128.170.133&quot;,</span><br><span class="line">        &quot;10.128.170.134&quot;,</span><br><span class="line">        &quot;10.128.170.135&quot;,</span><br><span class="line">        &quot;localhost&quot;,</span><br><span class="line">        &quot;master1&quot;,</span><br><span class="line">        &quot;master2&quot;,</span><br><span class="line">        &quot;master3&quot;,</span><br><span class="line">        &quot;worker1&quot;,</span><br><span class="line">        &quot;worker2&quot;,</span><br><span class="line">        &quot;worker3&quot;,</span><br><span class="line">        &quot;worker4&quot;,</span><br><span class="line">        &quot;worker5&quot;,</span><br><span class="line">        &quot;master1.local&quot;,</span><br><span class="line">        &quot;master2.local&quot;,</span><br><span class="line">        &quot;master3.local&quot;,</span><br><span class="line">        &quot;worker1.local&quot;,</span><br><span class="line">        &quot;worker2.local&quot;,</span><br><span class="line">        &quot;worker3.local&quot;,</span><br><span class="line">        &quot;worker4.local&quot;,</span><br><span class="line">        &quot;worker5.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-controller-manager 证书</span></span><br><span class="line">➜ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh kube-controller-manager*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 14 00:55 kube-controller-manager-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.8K Jul 14 00:55 kube-controller-manager.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-controler-manager 证书到 /etc/kubernetes/pki</span></span><br><span class="line">➜ cp kube-controller-manager*pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>
<p>system:kube-controller-manager 是 Kubernetes 中的一个预定义 RBAC 角色，用于授权 kube-controller-manager 组件对 Kubernetes API 的访问。详细介绍请参考官方文档：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" class="uri">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings</a></p>
<h3 id="部署-kube-controller-manager-1">7.2 部署 kube-controller-manager</h3>
<p>编写服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以使用 kubeadm 生成示例配置文件，然后进行修改</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubeadm init phase control-plane controller-manager --dry-run -v 4</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">I0717 00:18:23.798277    6694 manifests.go:154] [control-plane] wrote static Pod manifest <span class="keyword">for</span> component <span class="string">&quot;kube-controller-manager&quot;</span> to <span class="string">&quot;/etc/kubernetes/tmp/kubeadm-init-dryrun963226442/kube-controller-manager.yaml&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/kubernetes/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--secure-port=10257 \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/16 \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">  --cluster-signing-duration=87600h \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/kube-controller-manager.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/kube-controller-manager-key.pem \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --leader-elect=true \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --use-service-account-credentials=true \</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \</span><br><span class="line">  --allocate-node-cidrs=true \</span><br><span class="line">  --cluster-cidr=10.240.0.0/12 \</span><br><span class="line">  --v=4&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>生成 kubeconfig：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.128.170.21:6443 --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-credentials kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-context default --cluster=kubernetes --user=kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ cp kube-controller-manager.kubeconfig /etc/kubernetes/</span><br></pre></td></tr></table></figure>
<p>编写服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes controller manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动 kube-controller-manager 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kube-controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kube-controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kube-controller-manager</span><br></pre></td></tr></table></figure>
<p>查看组件状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get cs</span><br><span class="line"></span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                        ERROR</span><br><span class="line">scheduler            Unhealthy   Get &quot;https://127.0.0.1:10259/healthz&quot;: dial tcp 127.0.0.1:10259: connect: connection refused</span><br><span class="line">controller-manager   Healthy     ok</span><br><span class="line">etcd-0               Healthy     &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="部署-kube-scheduler">8. 部署 kube-scheduler</h2>
<p><strong>只需在 master 节点（也即 master1 节点）部署即可。</strong></p>
<h3 id="颁发证书-4">8.1 颁发证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-scheduler 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有节点地址，这里可以做好规划，预留几个 IP，以备后续扩容。</span></span><br><span class="line">➜ cat &gt; kube-scheduler-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.128.170.21&quot;,</span><br><span class="line">        &quot;10.128.170.22&quot;,</span><br><span class="line">        &quot;10.128.170.23&quot;,</span><br><span class="line">        &quot;10.128.170.131&quot;,</span><br><span class="line">        &quot;10.128.170.132&quot;,</span><br><span class="line">        &quot;10.128.170.133&quot;,</span><br><span class="line">        &quot;10.128.170.134&quot;,</span><br><span class="line">        &quot;10.128.170.135&quot;,</span><br><span class="line">        &quot;localhost&quot;,</span><br><span class="line">        &quot;master1&quot;,</span><br><span class="line">        &quot;master2&quot;,</span><br><span class="line">        &quot;master3&quot;,</span><br><span class="line">        &quot;worker1&quot;,</span><br><span class="line">        &quot;worker2&quot;,</span><br><span class="line">        &quot;worker3&quot;,</span><br><span class="line">        &quot;worker4&quot;,</span><br><span class="line">        &quot;worker5&quot;,</span><br><span class="line">        &quot;master1.local&quot;,</span><br><span class="line">        &quot;master2.local&quot;,</span><br><span class="line">        &quot;master3.local&quot;,</span><br><span class="line">        &quot;worker1.local&quot;,</span><br><span class="line">        &quot;worker2.local&quot;,</span><br><span class="line">        &quot;worker3.local&quot;,</span><br><span class="line">        &quot;worker4.local&quot;,</span><br><span class="line">        &quot;worker5.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-scheduler 证书</span></span><br><span class="line">➜ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh kube-scheduler*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 14 01:06 kube-scheduler-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.8K Jul 14 01:06 kube-scheduler.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-scheduler 证书到 /etc/kubernetes/pki</span></span><br><span class="line">➜ cp kube-scheduler*pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>
<h3 id="部署-kube-scheduler-1">8.2 部署 kube-scheduler</h3>
<p>编写服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以使用 kubeadm 生成示例配置文件，然后进行修改</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubeadm init phase control-plane scheduler --dry-run -v 4</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">I0717 00:26:08.548412    6903 manifests.go:154] [control-plane] wrote static Pod manifest <span class="keyword">for</span> component <span class="string">&quot;kube-scheduler&quot;</span> to <span class="string">&quot;/etc/kubernetes/tmp/kubeadm-init-dryrun1609159078/kube-scheduler.yaml&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/kubernetes/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--bind-address=127.0.0.1 \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">  --leader-elect=true \</span><br><span class="line">  --v=4&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>生成 kubeconfig</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.128.170.21:6443 --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-credentials kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-context default --cluster=kubernetes --user=kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ cp kube-scheduler.kubeconfig /etc/kubernetes/</span><br></pre></td></tr></table></figure>
<p>编写服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动 kube-scheduler 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kube-scheduler</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kube-scheduler</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kube-scheduler</span><br></pre></td></tr></table></figure>
<p>查看组件状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get cs</span><br><span class="line"></span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;,&quot;reason&quot;:&quot;&quot;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="部署-kubelet">9. 部署 kubelet</h2>
<p><strong>先在 master 节点完成部署，后续添加 worker 节点时从 master 节点复制配置并调整即可。</strong></p>
<p>master 节点上部署 kubelet 是可选的，一旦部署 kubelet，master 节点也可以运行 Pod，如果不希望 master 节点上运行 Pod，则可以给 master 节点打上污点。</p>
<p>master 节点部署 kubelet 是有好处的，一是可以通过诸如 <code>kubectl get node</code> 等命令查看节点信息，二是可以在上面部署监控系统，日志采集系统等。</p>
<h3 id="授权-kubelet-允许请求证书">9.1 授权 kubelet 允许请求证书</h3>
<p>授权 kubelet-bootstrap 用户允许请求证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"></span><br><span class="line">➜ kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">--clusterrole=system:node-bootstrapper \</span><br><span class="line">--user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</span><br></pre></td></tr></table></figure>
<h3 id="部署-kubelet-1">9.2 部署 kubelet</h3>
<p>编写服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以使用 kubeadm 生成示例配置文件，然后进行修改</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubeadm init phase kubelet-start --dry-run</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/etc/kubernetes/tmp/kubeadm-init-dryrun3282605628/kubeadm-flags.env&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/etc/kubernetes/tmp/kubeadm-init-dryrun3282605628/config.yaml&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes-sigs/sig-windows-tools/issues/323</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/kubernetes/pull/118544</span></span><br><span class="line">➜ cat &gt; /etc/kubernetes/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=&quot;--bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet.yaml \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/pki \</span><br><span class="line">  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \</span><br><span class="line">  --pod-infra-container-image=registry.k8s.io/pause:3.9 \</span><br><span class="line">  --v=4</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/kubernetes/kubelet.yaml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 0</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">rotateCertificates: true</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>生成 kubeconfig：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.128.170.21:6443 --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-credentials kubelet-bootstrap --token=$(awk -F, &#x27;&#123;print $1&#125;&#x27; /etc/kubernetes/token.csv) --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ cp kubelet-bootstrap.kubeconfig /etc/kubernetes/</span><br></pre></td></tr></table></figure>
<p>编写服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes kubelet</span><br><span class="line">After=network.target network-online.targer containerd.service</span><br><span class="line">Requires=containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/kubernetes/kubelet.conf</span><br><span class="line">ExecStart=/usr/local/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动 kubelet 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kubelet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kubelet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kubelet</span><br></pre></td></tr></table></figure>
<p>批准节点加入集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get csr</span><br><span class="line"></span><br><span class="line">NAME        AGE   SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-h92vn   59s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Pending</span><br><span class="line"></span><br><span class="line">➜ kubectl certificate approve csr-h92vn</span><br><span class="line"></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-h92vn approved</span><br><span class="line"></span><br><span class="line">➜ kubectl get csr</span><br><span class="line"></span><br><span class="line">NAME        AGE     SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-h92vn   2m27s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Approved,Issued</span><br></pre></td></tr></table></figure>
<p>查看节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get node</span><br><span class="line"></span><br><span class="line">NAME      STATUS     ROLES    AGE   VERSION</span><br><span class="line">master1   NotReady   &lt;none&gt;   71s   v1.27.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时节点状态还是 NotReady，因为还没有安装网络插件，正确安装网络插件后，状态会变为 Ready.</span></span><br></pre></td></tr></table></figure>
<h2 id="部署-kube-proxy">10. 部署 kube-proxy</h2>
<p><strong>先在 master 节点完成部署，后续添加 worker 节点时从 master 节点复制配置并调整即可。</strong></p>
<h3 id="颁发证书-5">10.1 颁发证书</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 /etc/kubernetes/ssl 目录</span></span><br><span class="line">➜ cd /etc/kubernetes/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-proxy 证书签署申请</span></span><br><span class="line">➜ cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;GuangDong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-proxy 证书</span></span><br><span class="line">➜ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">➜ ls -lh kube-proxy*pem</span><br><span class="line"></span><br><span class="line">-rw------- 1 root root 1.7K Jul 15 18:36 kube-proxy-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1.4K Jul 15 18:36 kube-proxy.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-proxy 证书到 /etc/kubernetes/pki</span></span><br><span class="line">➜ cp kube-proxy*pem /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>
<h3 id="部署-kube-proxy-1">10.2 部署 kube-proxy</h3>
<p>编写服务配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /etc/kubernetes/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--config=/etc/kubernetes/kube-proxy.yaml \</span><br><span class="line">  --v=4</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clusterCIDR: 10.240.0.0/12</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">mode: ipvs</span><br><span class="line">ipvs:</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>生成 kubeconfig：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.128.170.21:6443 --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">➜ cp kube-proxy.kubeconfig /etc/kubernetes/</span><br></pre></td></tr></table></figure>
<p>编写服务启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; &quot;EOF&quot;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-proxy.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>启动 kube-proxy 服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kube-proxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kube-proxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kube-proxy</span><br></pre></td></tr></table></figure>
<h2 id="部署集群网络">11. 部署集群网络</h2>
<p><strong>只需在 master 节点（也即 master1 节点）部署即可。</strong></p>
<h3 id="部署-calico">11.1 部署 calico</h3>
<p>参考文档 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises">Install Calico networking and network policy for on-premises deployments</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"></span><br><span class="line">➜ curl -k https://cdn.jsdelivr.net/gh/projectcalico/calico@v3.26.1/manifests/calico.yaml -O</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">找到 CALICO_IPV4POOL_CIDR 变量，取消注释并修改 Pod IP 地址段</span></span><br><span class="line">➜ sed -i &#x27;s/# \(- name: CALICO_IPV4POOL_CIDR\)/\1/&#x27; calico.yaml</span><br><span class="line">➜ sed -i &#x27;s/#   value: &quot;192.168.0.0\/16&quot;/  value: &quot;10.240.0.0\/12&quot;/&#x27; calico.yaml</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line">poddisruptionbudget.policy/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-node created</span><br><span class="line">serviceaccount/calico-cni-plugin created</span><br><span class="line">configmap/calico-config created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgpfilters.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-cni-plugin created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-cni-plugin created</span><br><span class="line">daemonset.apps/calico-node created</span><br><span class="line">deployment.apps/calico-kube-controllers created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看网络 pod</span></span><br><span class="line">➜ kubectl -n kube-system get pod</span><br><span class="line"></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-85578c44bf-7v87p   1/1     Running   0          25m</span><br><span class="line">calico-node-v924z                          1/1     Running   0          25m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 node 状态</span></span><br><span class="line">➜ kubectl get node</span><br><span class="line"></span><br><span class="line">NAME      STATUS   ROLES    AGE   VERSION</span><br><span class="line">master1   Ready    &lt;none&gt;   30m   v1.27.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 ipvs 模式</span></span><br><span class="line">➜ ipvsadm -Ln</span><br><span class="line"></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">10.128.170.21:6443           Masq    1      5          0</span></span><br></pre></td></tr></table></figure>
<p><strong>如果 node 状态仍然是 NotReady，基本上是镜像未拉取完成或拉取失败导致的，如果一段时间后仍拉取失败，则尝试手动拉取镜像。</strong></p>
<h3 id="授权-kube-apiserver-访问-kubelet">11.2 授权 kube-apiserver 访问 kubelet</h3>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Using RBAC Authorization</a></p>
<p>应用场景：例如 kubectl exec/run/logs</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"></span><br><span class="line">➜ cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">      - pods/log</span><br><span class="line">    verbs:</span><br><span class="line">      - &quot;*&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: &quot;&quot;</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kubernetes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br><span class="line"></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</span><br><span class="line"></span><br><span class="line">➜ kubectl -n kube-system logs calico-kube-controllers-85578c44bf-7v87p</span><br></pre></td></tr></table></figure>
<h3 id="部署-coredns">11.3 部署 coredns</h3>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/coredns/deployment/blob/master/kubernetes/coredns.yaml.sed" class="uri">https://github.com/coredns/deployment/blob/master/kubernetes/coredns.yaml.sed</a></p>
<p><strong>coredns.yaml.sed 原始文件见附录章节 "16.1 coredns.yaml.sed"，该 yaml 指定使用的 coredns 的版本是 1.9.4。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载 yaml 文件</span></span><br><span class="line">➜ curl https://raw.kgithub.com/coredns/deployment/master/kubernetes/coredns.yaml.sed -o coredns.yaml</span><br></pre></td></tr></table></figure>
<p>修改配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;coredns/coredns:1.9.4&quot;</span> 替换为 <span class="string">&quot;coredns/coredns:1.10.1&quot;</span></span></span><br><span class="line">➜ sed -i &#x27;s/coredns\/coredns:1.9.4/coredns\/coredns:1.10.1/g&#x27; coredns.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;CLUSTER_DOMAIN&quot;</span> 替换为 <span class="string">&quot;cluster.local&quot;</span></span></span><br><span class="line">➜ sed -i &#x27;s/CLUSTER_DOMAIN/cluster.local/g&#x27; coredns.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;REVERSE_CIDRS&quot;</span> 替换为 <span class="string">&quot;in-addr.arpa ip6.arpa&quot;</span></span></span><br><span class="line">➜ sed -i &#x27;s/REVERSE_CIDRS/in-addr.arpa ip6.arpa/g&#x27; coredns.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;UPSTREAMNAMESERVER&quot;</span> 替换为 <span class="string">&quot;/etc/resolv.conf&quot;</span>（或当前网络所使用的 DNS 地址）</span></span><br><span class="line">➜ sed -i &#x27;s/UPSTREAMNAMESERVER/\/etc\/resolv.conf/g&#x27; coredns.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;STUBDOMAINS&quot;</span> 替换为 <span class="string">&quot;&quot;</span></span></span><br><span class="line">➜ sed -i &#x27;s/STUBDOMAINS//g&#x27; coredns.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;CLUSTER_DNS_IP&quot;</span> 替换为 <span class="string">&quot;10.96.0.10&quot;</span>（与 kubelet.yaml 配置的 clusterDNS 一致）</span></span><br><span class="line">➜ sed -i &#x27;s/CLUSTER_DNS_IP/10.96.0.10/g&#x27; coredns.yaml</span><br></pre></td></tr></table></figure>
<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl apply -f coredns.yaml</span><br><span class="line"></span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure>
<p>验证<strong>（如果 calico 的 pod 未就绪，请检查是否是镜像拉取未完成或镜像拉取失败）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl -n kube-system get deploy,pod,svc</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/calico-kube-controllers   1/1     1            1           23h</span><br><span class="line">deployment.apps/coredns                   1/1     1            1           43s</span><br><span class="line"></span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/calico-kube-controllers-85578c44bf-7v87p   1/1     Running   0          23h</span><br><span class="line">pod/calico-node-v924z                          1/1     Running   0          23h</span><br><span class="line">pod/coredns-db5667c87-zg9s8                    1/1     Running   0          41s</span><br><span class="line"></span><br><span class="line">NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   43s</span><br></pre></td></tr></table></figure>
<p>dig 测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ yum -y install bind-utils</span><br><span class="line"></span><br><span class="line">➜ dig -t A www.baidu.com @10.96.0.10 +short</span><br><span class="line"></span><br><span class="line">www.a.shifen.com.</span><br><span class="line">14.119.104.254</span><br><span class="line">14.119.104.189</span><br></pre></td></tr></table></figure>
<p>pod 测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl run -it --rm --image=busybox:1.28.3 -- sh</span><br><span class="line"></span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">options ndots:5</span><br><span class="line">/ # nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line">/ # ping -c 4 www.baidu.com</span><br><span class="line">PING www.baidu.com (14.119.104.254): 56 data bytes</span><br><span class="line">64 bytes from 14.119.104.254: seq=0 ttl=127 time=14.193 ms</span><br><span class="line">64 bytes from 14.119.104.254: seq=1 ttl=127 time=12.848 ms</span><br><span class="line">64 bytes from 14.119.104.254: seq=2 ttl=127 time=18.553 ms</span><br><span class="line">64 bytes from 14.119.104.254: seq=3 ttl=127 time=23.581 ms</span><br><span class="line"></span><br><span class="line">--- www.baidu.com ping statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 12.848/17.293/23.581 ms</span><br></pre></td></tr></table></figure>
<h2 id="添加-worker-节点">12. 添加 worker 节点</h2>
<p>worker 节点需要部署两个组件 <code>kubelet</code>, <code>kube-proxy</code>。</p>
<p><strong>在 master 节点执行，从 master 节点上复制以下文件到 worker 节点：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜ scp /etc/kubernetes/pki/ca.pem \</span><br><span class="line">       /etc/kubernetes/pki/kube-proxy.pem \</span><br><span class="line">       /etc/kubernetes/pki/kube-proxy-key.pem \</span><br><span class="line">       root@worker1:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">➜ scp /etc/kubernetes/kubelet.conf \</span><br><span class="line">       /etc/kubernetes/kubelet.yaml \</span><br><span class="line">       /etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">       /etc/kubernetes/kube-proxy.conf \</span><br><span class="line">       /etc/kubernetes/kube-proxy.yaml \</span><br><span class="line">       /etc/kubernetes/kube-proxy.kubeconfig \</span><br><span class="line">       root@worker1:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">➜ scp /usr/lib/systemd/system/kubelet.service \</span><br><span class="line">       /usr/lib/systemd/system/kube-proxy.service \</span><br><span class="line">       root@worker1:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">➜ scp /usr/local/bin/kubelet \</span><br><span class="line">       /usr/local/bin/kube-proxy \</span><br><span class="line">       root@worker1:/usr/local/bin/</span><br></pre></td></tr></table></figure>
<p><strong>在 worker 节点执行，worker 节点启动 kube-proxy 服务：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kube-proxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kube-proxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kube-proxy</span><br></pre></td></tr></table></figure>
<p><strong>在 worker 节点执行，worker 节点启动 kubelet 服务：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜ systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">➜ systemctl enable --now kubelet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果</span></span><br><span class="line">➜ systemctl status kubelet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">➜ journalctl -u kubelet</span><br></pre></td></tr></table></figure>
<p>（master 节点执行）批准 worker 节点加入集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get csr</span><br><span class="line">NAME        AGE   SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-9twkl   85s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Pending</span><br><span class="line"></span><br><span class="line">➜ kubectl certificate approve csr-9twkl</span><br><span class="line"></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-9twkl approved</span><br><span class="line"></span><br><span class="line">➜ kubectl get csr</span><br><span class="line"></span><br><span class="line">NAME        AGE     SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION</span><br><span class="line">csr-9twkl   2m15s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Approved,Issued</span><br></pre></td></tr></table></figure>
<p><strong>在 master 节点执行，查看节点：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl get node</span><br><span class="line"></span><br><span class="line">NAME      STATUS   ROLES    AGE   VERSION</span><br><span class="line">master1   Ready    &lt;none&gt;   47h   v1.27.3</span><br><span class="line">worker1   Ready    &lt;none&gt;   26m   v1.27.3</span><br></pre></td></tr></table></figure>
<p><strong>如果 worker1 的状态仍是 NotReady，请检查是否是镜像拉取未完成或镜像拉取失败。</strong></p>
<h2 id="禁止-master-节点运行-pod">13. 禁止 master 节点运行 pod</h2>
<p>至此 1 master 1 worker 的 k8s 二进制集群已搭建完毕。</p>
<p>此外，还可以给节点打上角色标签，使得查看节点信息更加直观：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给 master 节点打上 master,etcd 角色标签</span></span><br><span class="line">➜ kubectl label node master1 node-role.kubernetes.io/master=true node-role.kubernetes.io/etcd=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给 worker 节点打上 worker 角色标签</span></span><br><span class="line">➜ kubectl label node worker1 node-role.kubernetes.io/worker=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看标签</span></span><br><span class="line">➜ kubectl get node --show-labels</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除标签</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubectl label node master1 node-role.kubernetes.io/etcd-</span></span><br></pre></td></tr></table></figure>
<p>如果不希望 master 节点运行 Pod，则给 master 打上污点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加污点</span></span><br><span class="line">➜ kubectl taint node master1 node-role.kubernetes.io/master=true:NoSchedule</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看污点</span></span><br><span class="line">➜ kubectl describe node master1 | grep Taints</span><br><span class="line"></span><br><span class="line">Taints:             node-role.kubernetes.io/master=true:NoSchedule</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看全部节点的污点</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubectl get nodes -o jsonpath=<span class="string">&#x27;&#123;range .items[*]&#125;&#123;.metadata.name&#125;&#123;&quot;\n&quot;&#125;&#123;.spec.taints&#125;&#123;&quot;\n\n&quot;&#125;&#123;end&#125;&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除污点</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">➜ kubectl taint node master1 node-role.kubernetes.io/master-</span></span><br></pre></td></tr></table></figure>
<p>后续可以新增 2 个 etcd 节点组成 etcd 集群，新增 2 个控制平面，避免单点故障。</p>
<h2 id="测试应用服务部署">14. 测试应用服务部署</h2>
<p>创建 namespace：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl create namespace dev</span><br><span class="line"></span><br><span class="line">namespace/dev created</span><br><span class="line"></span><br><span class="line">➜ kubectl get namespace</span><br><span class="line"></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   2d</span><br><span class="line">dev               Active   7m</span><br><span class="line">kube-node-lease   Active   2d</span><br><span class="line">kube-public       Active   2d</span><br><span class="line">kube-system       Active   2d</span><br></pre></td></tr></table></figure>
<p>创建 deployment：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">➜ mkdir -p /etc/kubernetes/demo</span><br><span class="line"></span><br><span class="line">➜ cat &gt; /etc/kubernetes/demo/nginx-deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  namespace: dev</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-pod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-pod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f /etc/kubernetes/demo/nginx-deployment.yaml</span><br><span class="line"></span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line"></span><br><span class="line">➜ kubectl -n dev get pod</span><br><span class="line"></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deployment-6d76bcb866-zl52j   1/1     Running   0          23s</span><br></pre></td></tr></table></figure>
<p>创建 service：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜ cat &gt; /etc/kubernetes/demo/nginx-service.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-service</span><br><span class="line">  namespace: dev</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-pod</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 30001</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f /etc/kubernetes/demo/nginx-service.yaml</span><br><span class="line"></span><br><span class="line">service/nginx-service created</span><br><span class="line"></span><br><span class="line">➜ kubectl -n dev get svc</span><br><span class="line"></span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx-service   NodePort   10.96.195.221   &lt;none&gt;        80:30001/TCP   13s</span><br></pre></td></tr></table></figure>
<p>测试服务访问：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜ curl 10.128.170.21:30001 -I</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.25.1</span><br><span class="line">Date: Tue, 18 Jul 2023 16:56:37 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 13 Jun 2023 15:08:10 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;6488865a-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="部署-dashboard">15. 部署 Dashboard</h2>
<p>在 Kubernetes 社区中，有一个很受欢迎的 Dashboard 项目，它可以给用户提供一个可视化的 Web 界面来查看当前集群的各种信息。用户可以用 Kubernetes Dashboard 部署容器化的应用、监控应用的状态、执行故障排查任务以及管理 Kubernetes 各种资源。</p>
<p>官方参考文档：</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" class="uri">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kubernetes/dashboard/tree/v2.7.0" class="uri">https://github.com/kubernetes/dashboard/tree/v2.7.0</a></li>
</ul>
<p>使用 nodeport 方式将 dashboard 服务暴露在集群外，指定使用 30443 端口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载相关 yaml 文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/dashboard/blob/v2.7.0/aio/deploy/recommended.yaml</span></span><br><span class="line">➜ curl https://fastly.jsdelivr.net/gh/kubernetes/dashboard@v2.7.0/aio/deploy/recommended.yaml -o kubernetes-dashboard.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 Service 部分</span></span><br><span class="line">➜ vim kubernetes-dashboard.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort  # 新增</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30443  # 新增</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署</span></span><br><span class="line">➜ kubectl apply -f kubernetes-dashboard.yaml</span><br><span class="line"></span><br><span class="line">namespace/kubernetes-dashboard created</span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-csrf created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br><span class="line">service/dashboard-metrics-scraper created</span><br><span class="line">deployment.apps/dashboard-metrics-scraper created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 kubernetes-dashboard 下的资源</span></span><br><span class="line">➜ kubectl -n kubernetes-dashboard get deploy</span><br><span class="line"></span><br><span class="line">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">dashboard-metrics-scraper   1/1     1            1           5m26s</span><br><span class="line">kubernetes-dashboard        1/1     1            1           5m28s</span><br><span class="line"></span><br><span class="line">➜ kubectl -n kubernetes-dashboard get pod</span><br><span class="line"></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-5cb4f4bb9c-8qpbc   1/1     Running   0          6m22s</span><br><span class="line">kubernetes-dashboard-6967859bff-fvhkv        1/1     Running   0          6m22s</span><br><span class="line"></span><br><span class="line">➜ kubectl get svc -n kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">NAME                        TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.96.6.178   &lt;none&gt;        8000/TCP        6m37s</span><br><span class="line">kubernetes-dashboard        NodePort    10.96.8.70    &lt;none&gt;        443:30443/TCP   6m41s</span><br></pre></td></tr></table></figure>
<p><strong>如果 kubernetes-dashboard 下的资源一直未就绪，请检查是否是正在拉取镜像或者镜像一直拉取失败。</strong></p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl -n kubernetes-dashboard describe pod kubernetes-dashboard-546cbc58cd-hzvhr</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  6m20s  default-scheduler  Successfully assigned kubernetes-dashboard/kubernetes-dashboard-546cbc58cd-hzvhr to worker1</span><br><span class="line">  Normal  Pulling    6m20s  kubelet            Pulling image &quot;kubernetesui/dashboard:v2.5.0&quot;</span><br><span class="line"></span><br><span class="line">➜ kubectl -n kubernetes-dashboard describe pod kubernetes-dashboard-546cbc58cd-hzvhr</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason          Age                 From               Message</span><br><span class="line">  ----     ------          ----                ----               -------</span><br><span class="line">  Normal   Scheduled       10m                 default-scheduler  Successfully assigned kubernetes-dashboard/kubernetes-dashboard-546cbc58cd-hzvhr to worker1</span><br><span class="line">  Warning  Failed          2m1s                kubelet            Failed to pull image &quot;kubernetesui/dashboard:v2.5.0&quot;: rpc error: code = Unknown desc = dial tcp 104.18.124.25:443: i/o timeout</span><br><span class="line">  Warning  Failed          2m1s                kubelet            Error: ErrImagePull</span><br><span class="line">  Normal   SandboxChanged  2m                  kubelet            Pod sandbox changed, it will be killed and re-created.</span><br><span class="line">  Normal   BackOff         118s (x3 over 2m)   kubelet            Back-off pulling image &quot;kubernetesui/dashboard:v2.5.0&quot;</span><br><span class="line">  Warning  Failed          118s (x3 over 2m)   kubelet            Error: ImagePullBackOff</span><br><span class="line">  Normal   Pulling         106s (x2 over 10m)  kubelet            Pulling image &quot;kubernetesui/dashboard:v2.5.0&quot;</span><br><span class="line">  Normal   Pulled          25s                 kubelet            Successfully pulled image &quot;kubernetesui/dashboard:v2.5.0&quot; in 1m21.608630166s</span><br><span class="line">  Normal   Created         22s                 kubelet            Created container kubernetes-dashboard</span><br><span class="line">  Normal   Started         21s                 kubelet            Started container kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<p>创建 service account 并绑定默认 cluster-admin 管理员集群角色：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面创建了一个叫 admin-user 的服务账号，放在 kubernetes-dashboard 命名空间下，并将 cluster-admin 角色绑定到 admin-user 账户，这样 admin-user 账户就有了管理员的权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认情况下，kubeadm 创建集群时已经创建了 cluster-admin 角色，我们直接绑定即可。</span></span><br><span class="line">➜ cat &gt; dashboard-admin-user.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: admin-user</span><br><span class="line">    namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/kubernetes/issues/110113<span class="comment">#issuecomment-1130412032</span></span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">type: kubernetes.io/service-account-token</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/service-account.name: admin-user</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">应用资源配置清单</span></span><br><span class="line">➜ kubectl apply -f dashboard-admin-user.yaml</span><br><span class="line"></span><br><span class="line">serviceaccount/admin-user created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br><span class="line">secret/admin-user created</span><br></pre></td></tr></table></figure>
<p>查看 admin-user 账户的 token：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜ kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">Name:         admin-user</span><br><span class="line">Namespace:    kubernetes-dashboard</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: 630430bb-4ea5-4026-81ef-9d4c39089bca</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1318 bytes</span><br><span class="line">namespace:  20 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlRpS0VJZ0pkRW5va3Bsb2lKOUxVRXVtM3l6RFNtaFNzUkFFLW1zcXBHS2sifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI2MzA0MzBiYi00ZWE1LTQwMjYtODFlZi05ZDRjMzkwODliY2EiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.C-HqHea6OsWhQ9-yjPo0DGLhrgvtQ1cdaXOeGBOZqDKbPU4s-8VO31Ihw9Fbxo6vQnLJUyzFvRVB45eKr_95sJUht1lnD4pZOJHqnvSAa9SzkHbt4FcylHHG723wplLJc3fvnyKr1u3g74hHRUfLAE3q_VghMVwHi6hRyOalYN3KiFzQXKLVyovCxxAGwaEwJg9ftiawYMkDSzxLKkI17BBwrU_zt_xAKrLn229f9eEKsTeBMju0QMyhoWKCSVbV0chfw-sbJSUMAj7a8Ff5-uY1tru-QqUGI6RzlSKlI4E5hpsUVEFuU0HIHzrwxElTmNJnLZtcotFTLrsdHIXj2w</span><br></pre></td></tr></table></figure>
<p>使用输出的 token 登录 Dashboard：</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://10.128.170.21:30443" class="uri">https://10.128.170.21:30443</a></p>
<h2 id="附录">16. 附录</h2>
<h3 id="coredns.yaml.sed">16.1 coredns.yaml.sed</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:coredns</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">discovery.k8s.io</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">endpointslices</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:coredns</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:coredns</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        health &#123;</span></span><br><span class="line"><span class="string">          lameduck 5s</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ready</span></span><br><span class="line"><span class="string">        kubernetes CLUSTER_DOMAIN REVERSE_CIDRS &#123;</span></span><br><span class="line"><span class="string">          fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        forward . UPSTREAMNAMESERVER &#123;</span></span><br><span class="line"><span class="string">          max_concurrent 1000</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        loop</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;STUBDOMAINS</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">kubernetes.io/name:</span> <span class="string">&quot;CoreDNS&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># replicas: not specified here:</span></span><br><span class="line">  <span class="comment"># 1. Default is 1.</span></span><br><span class="line">  <span class="comment"># 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">coredns</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">coredns</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;CriticalAddonsOnly&quot;</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">         <span class="attr">podAntiAffinity:</span></span><br><span class="line">           <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">           <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">               <span class="attr">matchExpressions:</span></span><br><span class="line">               <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">k8s-app</span></span><br><span class="line">                 <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                 <span class="attr">values:</span> [<span class="string">&quot;kube-dns&quot;</span>]</span><br><span class="line">             <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">coredns/coredns:1.9.4</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">170Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">70Mi</span></span><br><span class="line">        <span class="attr">args:</span> [ <span class="string">&quot;-conf&quot;</span>, <span class="string">&quot;/etc/coredns/Corefile&quot;</span> ]</span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/coredns</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dns</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dns-tcp</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9153</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">all</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8181</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">Default</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">coredns</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">Corefile</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-dns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;9153&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">kubernetes.io/name:</span> <span class="string">&quot;CoreDNS&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">coredns</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">CLUSTER_DNS_IP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dns</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dns-tcp</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9153</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<h3 id="helm-安装-coredns">16.2 helm 安装 coredns</h3>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/coredns/helm" class="uri">https://github.com/coredns/helm</a></p>
<p>安装 helm：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ cd ~/Downloads</span><br><span class="line">➜ curl -O https://mirrors.huaweicloud.com/helm/v3.12.2/helm-v3.12.2-linux-amd64.tar.gz</span><br><span class="line">➜ tar -zxvf helm-v3.12.2-linux-amd64.tar.gz</span><br><span class="line">➜ cp linux-amd64/helm /usr/local/bin</span><br></pre></td></tr></table></figure>
<p>添加 chart 仓库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm repo add coredns https://coredns.github.io/helm</span><br></pre></td></tr></table></figure>
<p>查看可安装的版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜ helm search repo -l</span><br><span class="line"></span><br><span class="line">NAME            CHART VERSION   APP VERSION     DESCRIPTION</span><br><span class="line">coredns/coredns 1.24.1          1.10.1          CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.24.0          1.10.1          CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.23.0          1.10.1          CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.22.0          1.10.1          CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.21.0          1.10.1          CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.20.2          1.9.4           CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.20.1          1.9.4           CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">coredns/coredns 1.20.0          1.9.4           CoreDNS is a DNS server that chains plugins and...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>安装 coredns：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm --namespace=kube-system install coredns coredns/coredns</span><br></pre></td></tr></table></figure>
<h2 id="references">References</h2>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/it_zrs/article/details/126622431">K8s 高可用集群架构（二进制）部署及应用</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.haxi.cc/archives/setup-k8s-1-23-1-cluster-using-binary.html">二进制部署 k8s 集群 1.23.1 版本</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hebye.com/docs/k8s/k8s-1ct8ioki6h2qk#2nop09">部署一套完整的企业级k8s集群</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>lu wenye
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.wylu.me/posts/f5d33b91/" title="二进制部署 k8s 集群 1.27.3 版本">https://www.wylu.me/posts/f5d33b91/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i> kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/aff5958d/" rel="prev" title="Rocky Linux 部署 etcd 集群">
                  <i class="fa fa-chevron-left"></i> Rocky Linux 部署 etcd 集群
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/4d3c18db/" rel="next" title="FastDFS 安装部署">
                  FastDFS 安装部署 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-changyan">changyan</a></li>
            <li class="tab"><a href="#comment-disqus">disqus</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane changyan" id="comment-changyan">
              <div class="comments" id="SOHUCS" sid="28437754bccf8d40a6c44f1327b0c4f6"></div>
            </div>
            <div class="tab-pane disqus" id="comment-disqus">
              
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
            </div>
        </div>
      </div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">wylu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">152k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:13</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/wylu" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cywofsGy5","appkey":"81e9ec55ee07f76c5500fc2df8517c62","count":false}</script>
<script src="/js/third-party/comments/changyan.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"wylu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
